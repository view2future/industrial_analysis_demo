# Google Gemini API 集成验证指南

## 🎯 快速验证

运行测试脚本验证 API 集成:

```bash
cd /Users/wangyu94/regional-industrial-dashboard
python3 test_gemini_api.py
```

## 📊 新增的日志和UI功能

### 1. 详细的后端日志

现在系统会输出详细的日志信息，包括:

#### 初始化阶段
```
============================================================
初始化 Google Gemini LLM 报告生成器
============================================================
✓ API Key 已加载 (前10位): AIzaSyDHXc...
✓ API Key 长度: 39 字符
正在配置 Google Gemini API...
✓ API 配置成功
正在初始化 Gemini Pro 模型...
  - 模型名称: gemini-pro
  - Temperature: 0.7
  - Max tokens: 8192
✓ 模型初始化成功: models/gemini-pro
```

#### API 调用阶段
```
============================================================
🚀 开始生成报告: 成都市 - 人工智能
============================================================
📝 提示词长度: 2453 字符
🌐 调用 Google Gemini API (gemini-pro)...
⏱️  超时设置: 600 秒
📡 API 调用尝试 1/3...
✅ API 调用成功！耗时: 23.45 秒
📊 响应长度: 5234 字符
🔍 响应预览 (前200字): 成都市人工智能产业分析报告...
```

### 2. 前端实时状态显示

访问报告生成页面时，会看到:

#### 进度条显示
```
报告生成进度
━━━━━━━━━━━━━━━━━━━━━ 45%
🌐 调用 Google Gemini API 生成 成都市 人工智能 报告...
```

#### API 调用日志窗口
```
┌─ Google Gemini API 调用状态 ────────────────┐
│ ▶ [16:30:12] 任务已提交，等待处理...          │
│ ▶ [16:30:15] 正在初始化 Google Gemini API... │
│ ✓ [16:30:18] 正在调用 Google Gemini API...   │
│ ✓ [16:31:42] API 调用成功！                   │
│ ▶ [16:31:43] 正在使用 Gemini API 生成摘要...  │
│ ✓ [16:32:05] 正在使用 Gemini API 生成 SWOT... │
│ ✓ [16:32:28] 所有 API 调用完成，报告已生成！  │
└──────────────────────────────────────────────┘
```

### 3. Celery 任务日志

查看 `/Users/wangyu94/regional-industrial-dashboard/logs/celery.log`:

```
[2024-11-03 16:30:15] INFO - ================================================================================
[2024-11-03 16:30:15] INFO - 🚀 后台任务开始: 生成 LLM 报告
[2024-11-03 16:30:15] INFO - ================================================================================
[2024-11-03 16:30:15] INFO - 📍 城市: 成都市
[2024-11-03 16:30:15] INFO - 🏭 行业: 人工智能
[2024-11-03 16:30:18] INFO - ✅ LLM 报告生成器初始化完成
[2024-11-03 16:30:18] INFO - 🌐 开始调用 Google Gemini API...
[2024-11-03 16:31:42] INFO - ✅ Google Gemini API 调用成功，报告主体已生成
```

## 🔍 如何验证 API 正确调用

### 方法1: 运行测试脚本 (推荐)

```bash
python3 test_gemini_api.py
```

**成功输出示例:**
```
🧪 测试 Google Gemini API 连接
✓ google.generativeai 库导入成功
  版本: 0.8.5
✓ API Key 已加载
  前10位: AIzaSyDHXc...
✓ API 配置成功
✓ 模型初始化成功: models/gemini-pro
✅ API 调用成功！
  耗时: 2.34 秒
  响应内容: 测试成功

🎉 Google Gemini API 集成测试通过！
```

### 方法2: 查看 Celery 日志

```bash
tail -f /Users/wangyu94/regional-industrial-dashboard/logs/celery.log
```

查找关键信息:
- ✓ 看到 "API 配置成功"
- ✓ 看到 "模型初始化成功: models/gemini-pro"
- ✓ 看到 "API 调用成功！耗时: X.XX 秒"
- ✓ 看到 "响应长度: XXXX 字符"

### 方法3: 前端 UI 观察

访问 `http://localhost:5000/generate-report`，生成报告时观察:

1. **进度条** - 从 0% → 100%
2. **状态消息** - 显示 "调用 Google Gemini API"
3. **API 日志窗口** - 实时显示 API 调用过程
4. **最终结果** - 成功生成报告并跳转

## 📝 日志级别说明

| 符号 | 含义 | 示例 |
|------|------|------|
| ✓ | 成功 | ✓ API 配置成功 |
| ✗ | 失败 | ✗ API 调用失败 |
| ⚠ | 警告 | ⚠️ 提示词模板为空 |
| 🚀 | 开始 | 🚀 开始生成报告 |
| 🌐 | 网络 | 🌐 调用 Google Gemini API |
| 📊 | 数据 | 📊 响应长度: 5234 字符 |
| ⏱️ | 时间 | ⏱️ 超时设置: 600 秒 |

## 🐛 常见问题诊断

### 问题1: 看不到日志

**检查 Celery 是否运行:**
```bash
ps aux | grep celery
```

**查看日志文件:**
```bash
ls -la logs/celery.log
tail -50 logs/celery.log
```

### 问题2: API 调用一直卡住

**日志特征:**
```
📡 API 调用尝试 1/3...
(卡住，没有后续日志)
```

**可能原因:**
1. 网络无法访问 Google 服务器
2. 需要配置代理

**解决方案:**
参考 `NETWORK_SETUP.md` 配置代理

### 问题3: API 返回错误

**日志特征:**
```
✗ API 调用失败 (尝试 1/3)
   错误类型: ServiceUnavailable
   错误信息: 503 failed to connect...
```

**解决方案:**
1. 检查 API Key 是否有效
2. 检查网络连接
3. 配置代理服务

## 🎨 UI 组件说明

### 进度条
- **0-10%**: 初始化 API
- **10-20%**: 调用 API 生成主报告
- **20-60%**: 等待 API 响应
- **60-70%**: 生成中文摘要
- **70-80%**: 生成英文摘要
- **80-90%**: 生成 SWOT 分析
- **90-100%**: 保存报告

### API 日志窗口
- **蓝色 ▶**: 进行中
- **绿色 ✓**: 成功
- **红色 ✗**: 失败
- **黄色 ⚠**: 警告

## 🚀 下一步

1. **运行测试**: `python3 test_gemini_api.py`
2. **配置代理** (如需要): 参考 `NETWORK_SETUP.md`
3. **启动系统**: `./start.sh`
4. **生成报告**: 访问 `http://localhost:5000/generate-report`
5. **观察日志**: 实时查看 API 调用过程

---

**更新时间**: 2024-11-03  
**文档版本**: v2.0  
**API 版本**: google-generativeai 0.8.5
