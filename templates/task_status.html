{% extends "base.html" %}

{% block title %}æŠ¥å‘Šç”Ÿæˆä¸­ - åŒºåŸŸäº§ä¸šåˆ†æ{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 py-8">
    <div class="bg-white shadow-lg rounded-lg p-8">
        <!-- æ ‡é¢˜ -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">
                <i class="fas fa-robot mr-2 text-blue-600"></i>AI æŠ¥å‘Šç”Ÿæˆä¸­
            </h1>
            <p class="text-gray-600">æ­£åœ¨ä½¿ç”¨ <span id="model-name">AIæ¨¡å‹</span> ä¸ºæ‚¨ç”Ÿæˆä¸“ä¸šçš„äº§ä¸šåˆ†ææŠ¥å‘Š</p>
        </div>

        <!-- ç”Ÿæˆé˜¶æ®µå±•ç¤º -->
        <div class="space-y-4 mb-8">
            <!-- é˜¶æ®µ1: åˆå§‹åŒ– -->
            <div id="stage-init" class="stage-item p-4 rounded-lg border-2 border-gray-200 bg-gray-50 transition-all">
                <div class="flex items-center">
                    <div class="stage-icon mr-4">
                        <i class="fas fa-circle text-gray-400 text-xl"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-semibold text-gray-700">1. åˆå§‹åŒ– LLM API</h3>
                        <p class="text-sm text-gray-500 stage-message">å‡†å¤‡å°±ç»ª...</p>
                    </div>
                    <div class="stage-status">
                        <span class="text-sm text-gray-400">ç­‰å¾…ä¸­</span>
                    </div>
                </div>
            </div>

            <!-- é˜¶æ®µ2: ç”ŸæˆæŠ¥å‘Šä¸»ä½“ -->
            <div id="stage-generating" class="stage-item p-4 rounded-lg border-2 border-gray-200 bg-gray-50 transition-all">
                <div class="flex items-center">
                    <div class="stage-icon mr-4">
                        <i class="fas fa-circle text-gray-400 text-xl"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-semibold text-gray-700">2. ç”ŸæˆæŠ¥å‘Šä¸»ä½“</h3>
                        <p class="text-sm text-gray-500 stage-message">ç­‰å¾…ä¸­...</p>
                    </div>
                    <div class="stage-status">
                        <span class="text-sm text-gray-400">ç­‰å¾…ä¸­</span>
                    </div>
                </div>
            </div>

            <!-- é˜¶æ®µ3: ç”Ÿæˆæ‘˜è¦ -->
            <div id="stage-summary" class="stage-item p-4 rounded-lg border-2 border-gray-200 bg-gray-50 transition-all">
                <div class="flex items-center">
                    <div class="stage-icon mr-4">
                        <i class="fas fa-circle text-gray-400 text-xl"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-semibold text-gray-700">3. ç”Ÿæˆæ‰§è¡Œæ‘˜è¦</h3>
                        <p class="text-sm text-gray-500 stage-message">ç­‰å¾…ä¸­...</p>
                    </div>
                    <div class="stage-status">
                        <span class="text-sm text-gray-400">ç­‰å¾…ä¸­</span>
                    </div>
                </div>
            </div>

            <!-- é˜¶æ®µ4: ç”ŸæˆSWOT -->
            <div id="stage-swot" class="stage-item p-4 rounded-lg border-2 border-gray-200 bg-gray-50 transition-all">
                <div class="flex items-center">
                    <div class="stage-icon mr-4">
                        <i class="fas fa-circle text-gray-400 text-xl"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-semibold text-gray-700">4. ç”Ÿæˆ SWOT åˆ†æ</h3>
                        <p class="text-sm text-gray-500 stage-message">ç­‰å¾…ä¸­...</p>
                    </div>
                    <div class="stage-status">
                        <span class="text-sm text-gray-400">ç­‰å¾…ä¸­</span>
                    </div>
                </div>
            </div>

            <!-- é˜¶æ®µ5: ä¿å­˜æŠ¥å‘Š -->
            <div id="stage-saving" class="stage-item p-4 rounded-lg border-2 border-gray-200 bg-gray-50 transition-all">
                <div class="flex items-center">
                    <div class="stage-icon mr-4">
                        <i class="fas fa-circle text-gray-400 text-xl"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-semibold text-gray-700">5. ä¿å­˜æŠ¥å‘Šæ–‡ä»¶</h3>
                        <p class="text-sm text-gray-500 stage-message">ç­‰å¾…ä¸­...</p>
                    </div>
                    <div class="stage-status">
                        <span class="text-sm text-gray-400">ç­‰å¾…ä¸­</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- æŠ¥å‘Šä¿¡æ¯ -->
        <div id="report-info" class="hidden p-4 bg-blue-50 border-l-4 border-blue-500 rounded-lg mb-6">
            <h3 class="font-semibold text-blue-800 mb-2">
                <i class="fas fa-info-circle mr-2"></i>æŠ¥å‘Šè¯¦æƒ…
            </h3>
            <div class="text-sm text-blue-700 space-y-1">
                <p><strong>æŠ¥å‘ŠID:</strong> <span id="info-report-id" class="font-mono">-</span></p>
                <p><strong>å­˜å‚¨ä½ç½®:</strong> <span id="info-file-path" class="font-mono text-xs">-</span></p>
                <p><strong>æ–‡ä»¶å¤§å°:</strong> <span id="info-file-size">-</span></p>
                <p><strong>ç”Ÿæˆæ—¶é—´:</strong> <span id="info-generated-at">-</span></p>
            </div>
        </div>

        <!-- é”™è¯¯æç¤º -->
        <div id="error-section" class="hidden mt-6">
            <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg">
                <p class="text-red-800">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    <strong>ç”Ÿæˆå¤±è´¥:</strong> <span id="error-message"></span>
                </p>
                <a href="{{ url_for('generate_report') }}" class="inline-block mt-4 bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-colors">
                    <i class="fas fa-redo mr-2"></i>é‡æ–°ç”Ÿæˆ
                </a>
            </div>
        </div>

        <!-- å®Œæˆæç¤º -->
        <div id="success-section" class="hidden mt-6">
            <div class="bg-green-50 border-l-4 border-green-500 p-6 rounded-lg text-center">
                <div class="text-green-600 mb-4">
                    <i class="fas fa-check-circle text-6xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-green-800 mb-2">æŠ¥å‘Šç”Ÿæˆå®Œæˆï¼</h3>
                <p class="text-green-700 mb-6">æ­£åœ¨ä¸ºæ‚¨è·³è½¬åˆ°æŠ¥å‘Šé¡µé¢...</p>
                <div class="flex justify-center items-center space-x-2">
                    <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-green-600"></div>
                    <span class="text-green-600">è‡ªåŠ¨è·³è½¬ä¸­...</span>
                </div>
            </div>
        </div>

        <!-- æç¤ºä¿¡æ¯ -->
        <div class="mt-8 p-4 bg-gray-50 rounded-lg">
            <h3 class="font-semibold mb-2 text-gray-700">
                <i class="fas fa-lightbulb mr-2 text-yellow-500"></i>æ¸©é¦¨æç¤º
            </h3>
            <ul class="text-sm text-gray-600 space-y-1">
                <li><i class="fas fa-check text-green-500 mr-2"></i>æŠ¥å‘Šç”Ÿæˆé€šå¸¸éœ€è¦ 20-40 ç§’</li>
                <li><i class="fas fa-check text-green-500 mr-2"></i>ä½¿ç”¨ <span id="model-name-inline">AIæ¨¡å‹</span>ï¼Œè´¨é‡æœ‰ä¿éšœ</li>
                <li><i class="fas fa-check text-green-500 mr-2"></i>ç”Ÿæˆå®Œæˆåä¼šè‡ªåŠ¨è·³è½¬åˆ°æŠ¥å‘Šé¡µé¢</li>
                <li><i class="fas fa-check text-green-500 mr-2"></i>è¯·ä¿æŒé¡µé¢æ‰“å¼€ï¼Œä¸è¦å…³é—­æˆ–åˆ·æ–°</li>
            </ul>
        </div>
    </div>
</div>

<style>
.stage-item.active {
    border-color: #3b82f6;
    background-color: #eff6ff;
}

.stage-item.completed {
    border-color: #10b981;
    background-color: #f0fdf4;
}

.stage-item.error {
    border-color: #ef4444;
    background-color: #fef2f2;
}

.stage-icon .fa-circle {
    transition: all 0.3s ease;
}

.stage-item.active .stage-icon .fa-circle {
    color: #3b82f6;
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

.stage-item.completed .stage-icon .fa-circle {
    color: #10b981;
}

.stage-item.completed .stage-icon i::before {
    content: "\f058"; /* fa-check-circle */
}

.stage-item.error .stage-icon .fa-circle {
    color: #ef4444;
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.5;
    }
}
</style>

<script>
const taskId = "{{ task_id }}";
const reportId = "{{ report_id }}";
let checkInterval;

// é˜¶æ®µæ˜ å°„ - åŒ…å«æ‰€æœ‰å¯èƒ½çš„é˜¶æ®µçŠ¶æ€
const stageMap = {
    'init': 'stage-init',
    'generating': 'stage-generating',
    'report_done': 'stage-generating',
    'summary_zh': 'stage-summary',
    'summary_en': 'stage-summary',
    'summary_done': 'stage-summary',
    'swot': 'stage-swot',
    'swot_done': 'stage-swot',
    'saving': 'stage-saving',
    'saving_done': 'stage-saving',
    'completed': 'stage-saving'
};

// æ›´æ–°é˜¶æ®µçŠ¶æ€
function updateStage(stage, status, message) {
    const stageId = stageMap[stage];
    if (!stageId) {
        console.warn(`æ— æ³•æ˜ å°„é˜¶æ®µ: ${stage}`);
        return;
    }
    
    const stageElement = document.getElementById(stageId);
    if (!stageElement) {
        console.warn(`æ‰¾ä¸åˆ°å…ƒç´ : ${stageId}`);
        return;
    }
    
    console.log(`  ğŸ“ æ›´æ–°é˜¶æ®µ: ${stageId} -> ${status}, æ¶ˆæ¯: ${message}`);
    
    // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
    stageElement.classList.remove('active', 'completed', 'error');
    
    // æ·»åŠ æ–°çŠ¶æ€
    if (status === 'active') {
        stageElement.classList.add('active');
        stageElement.querySelector('.stage-status span').textContent = 'è¿›è¡Œä¸­...';
        stageElement.querySelector('.stage-status span').className = 'text-sm text-blue-600 font-semibold';
    } else if (status === 'completed') {
        stageElement.classList.add('completed');
        stageElement.querySelector('.stage-status span').textContent = 'âœ“ å®Œæˆ';
        stageElement.querySelector('.stage-status span').className = 'text-sm text-green-600 font-semibold';
    } else if (status === 'error') {
        stageElement.classList.add('error');
        stageElement.querySelector('.stage-status span').textContent = 'âœ— å¤±è´¥';
        stageElement.querySelector('.stage-status span').className = 'text-sm text-red-600 font-semibold';
    }
    
    // æ›´æ–°æ¶ˆæ¯
    if (message) {
        stageElement.querySelector('.stage-message').textContent = message;
    }
}

// æ ‡è®°ä¹‹å‰çš„é˜¶æ®µä¸ºå®Œæˆ
function markPreviousStagesCompleted(currentStage) {
    // UI æ˜¾ç¤ºçš„ 5 ä¸ªé˜¶æ®µ
    const uiStages = ['init', 'generating', 'summary', 'swot', 'saving'];
    
    // åç«¯ stage æ˜ å°„åˆ° UI é˜¶æ®µçš„ç´¢å¼•
    const stageToIndex = {
        'init': 0,
        'generating': 1,
        'report_done': 1,
        'summary_zh': 2,
        'summary_en': 2,
        'summary_done': 2,
        'swot': 3,
        'swot_done': 3,
        'saving': 4,
        'saving_done': 4,
        'completed': 5
    };
    
    const currentIndex = stageToIndex[currentStage];
    if (currentIndex === undefined) {
        console.warn(`æœªçŸ¥é˜¶æ®µ: ${currentStage}`);
        return;
    }
    
    // æ ‡è®°æ‰€æœ‰ä¹‹å‰çš„ UI é˜¶æ®µä¸ºå®Œæˆ
    for (let i = 0; i < Math.min(currentIndex, uiStages.length); i++) {
        const stageElement = document.getElementById(`stage-${uiStages[i]}`);
        if (stageElement && !stageElement.classList.contains('completed')) {
            stageElement.classList.remove('active');
            stageElement.classList.add('completed');
            const statusSpan = stageElement.querySelector('.stage-status span');
            if (statusSpan) {
                statusSpan.textContent = 'âœ“ å®Œæˆ';
                statusSpan.className = 'text-sm text-green-600 font-semibold';
            }
            console.log(`  âœ“ æ ‡è®° ${uiStages[i]} ä¸ºå®Œæˆ`);
        }
    }
}

// æ›´æ–°æ¨¡å‹åç§°æ˜¾ç¤º
function setModelName(name) {
    try {
        if (!name) return;
        const el1 = document.getElementById('model-name');
        const el2 = document.getElementById('model-name-inline');
        if (el1) el1.textContent = name;
        if (el2) el2.textContent = name;
    } catch (e) { console.warn('è®¾ç½®æ¨¡å‹åç§°å¤±è´¥', e); }
}

// æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
function checkTaskStatus() {
    fetch(`/task/${taskId}/status?report_id=${reportId}`)
        .then(response => response.json())
        .then(data => {
            console.log('ğŸ“Š Task status:', data);
            
            // åŒæ­¥æ¨¡å‹åç§°æ˜¾ç¤ºï¼ˆå¦‚æœåç«¯æä¾›ï¼‰
            const modelFromServer = data.model || (data.result && data.result.model);
            if (modelFromServer) setModelName(modelFromServer);

            if (data.state === 'PROGRESS') {
                const stage = data.stage || 'init';
                const message = data.message || data.status;
                
                console.log(`  ğŸ”¹ å½“å‰é˜¶æ®µ: ${stage}`);
                console.log(`  ğŸ”¹ æ¶ˆæ¯: ${message}`);
                
                // æ ‡è®°ä¹‹å‰çš„é˜¶æ®µä¸ºå®Œæˆ
                markPreviousStagesCompleted(stage);
                
                // æ›´æ–°å½“å‰é˜¶æ®µä¸ºè¿›è¡Œä¸­
                updateStage(stage, 'active', message);
            } 
            else if (data.state === 'SUCCESS') {
                console.log('âœ… ä»»åŠ¡æˆåŠŸå®Œæˆ');
                clearInterval(checkInterval);
                
                // æ ‡è®°æ‰€æœ‰é˜¶æ®µå®Œæˆ
                const allStages = ['init', 'generating', 'summary', 'swot', 'saving'];
                allStages.forEach(stageName => {
                    const stageElement = document.getElementById(`stage-${stageName}`);
                    if (stageElement) {
                        stageElement.classList.remove('active');
                        stageElement.classList.add('completed');
                        stageElement.querySelector('.stage-status span').textContent = 'âœ“ å®Œæˆ';
                        stageElement.querySelector('.stage-status span').className = 'text-sm text-green-600 font-semibold';
                    }
                });
                
                // æ˜¾ç¤ºæŠ¥å‘Šä¿¡æ¯
                const result = data.result || {};
                console.log('  ğŸ“„ æŠ¥å‘Šç»“æœ:', result);
                
                if (result.report_id) {
                    document.getElementById('report-info').classList.remove('hidden');
                    document.getElementById('info-report-id').textContent = result.report_id;
                    document.getElementById('info-file-path').textContent = result.file_path || '-';
                    document.getElementById('info-file-size').textContent = result.file_size || '-';
                    document.getElementById('info-generated-at').textContent = result.generated_at ? 
                        new Date(result.generated_at).toLocaleString('zh-CN') : '-';
                }
                
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                document.getElementById('success-section').classList.remove('hidden');
                
                // 3ç§’åè·³è½¬
                const actualReportId = result.report_id || reportId;
                console.log(`  ğŸ”— å°†è·³è½¬åˆ°: /report/${actualReportId}`);
                
                setTimeout(() => {
                    console.log('ğŸš€ æ­£åœ¨è·³è½¬...');
                    window.location.href = `/report/${actualReportId}`;
                }, 3000);
            } 
            else if (data.state === 'FAILURE' || data.state === 'ERROR') {
                console.log('âŒ ä»»åŠ¡å¤±è´¥:', data.status);
                clearInterval(checkInterval);
                
                // æ ‡è®°å½“å‰é˜¶æ®µä¸ºå¤±è´¥
                if (data.stage) {
                    updateStage(data.stage, 'error', data.message || data.status);
                }
                
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                document.getElementById('error-section').classList.remove('hidden');
                const errorMessage = data.error || data.status || 'æœªçŸ¥é”™è¯¯';
                document.getElementById('error-message').textContent = errorMessage;
            }
        })
        .catch(error => {
            console.error('âŒ æ£€æŸ¥çŠ¶æ€æ—¶å‡ºé”™:', error);
        });
}

// å¼€å§‹æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
console.log('ğŸš€ å¼€å§‹ç›‘æ§ä»»åŠ¡çŠ¶æ€');
console.log(`  Task ID: ${taskId}`);
console.log(`  Report ID: ${reportId}`);

checkTaskStatus();
checkInterval = setInterval(checkTaskStatus, 2000);

// è¶…æ—¶å¤„ç†
setTimeout(() => {
    if (checkInterval) {
        console.log('â±ï¸ ä»»åŠ¡è¶…æ—¶');
        clearInterval(checkInterval);
        document.getElementById('error-section').classList.remove('hidden');
        document.getElementById('error-message').textContent = 'ä»»åŠ¡è¶…æ—¶ï¼ˆè¶…è¿‡30åˆ†é’Ÿï¼‰ï¼Œè¯·æ£€æŸ¥ç³»ç»Ÿæ—¥å¿—';
    }
}, 30 * 60 * 1000);
</script>
{% endblock %}
