<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>实时生成 - 区域产业分析系统</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <div class="container-fluid">
      <a class="navbar-brand" href="{{ url_for('index') }}">⚡ 实时生成</a>
      <div class="ms-auto">
        <a href="{{ url_for('index') }}" class="btn btn-outline-light btn-sm">返回首页</a>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">实时输出</h5>
        <pre id="streamOutput" class="p-3 bg-light" style="height: 450px; overflow:auto;"></pre>
        <div class="text-end">
          <a id="btnToTask" class="btn btn-primary" href="{{ url_for('index') }}" style="display:none;">
            <i class="bi bi-arrow-right-circle"></i> 前往任务页面
          </a>
        </div>
      </div>
    </div>
  </div>

  <script>
    async function startStream() {
      const params = new URLSearchParams(window.location.search);
      const body = {
        city: params.get('city') || '',
        industry: params.get('industry') || '',
        llm_service: params.get('llm_service') || 'kimi',
        additional_context: params.get('additional_context') || ''
      };
      const out = document.getElementById('streamOutput');
      try {
        const resp = await fetch('/api/llm/stream', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const reader = resp.body.getReader();
        const decoder = new TextDecoder();
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          out.textContent += decoder.decode(value);
          out.scrollTop = out.scrollHeight;
        }
      } catch (e) {
        out.textContent += '\n[错误] ' + e.message;
      }
    }
    startStream();
  </script>
</body>
</html>
