<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ¥è¯†å›¾è°± - åŒºåŸŸäº§ä¸šåˆ†æå°å·¥ä½œå°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('index') }}">ğŸ”— çŸ¥è¯†å›¾è°±</a>
            <div class="ms-auto">
                <a href="{{ url_for('index') }}" class="btn btn-outline-light btn-sm">è¿”å›é¦–é¡µ</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-list-ul"></i> é€‰æ‹©æŠ¥å‘Š</h5>
                        <select class="form-select mb-3" id="reportSelect">
                            <option value="">-- é€‰æ‹©æŠ¥å‘Š --</option>
                            {% for report in reports %}
                            <option value="{{ report.report_id }}">{{ report.title }}</option>
                            {% endfor %}
                        </select>

                        <h6 class="mt-4">å›¾è°±ç±»å‹</h6>
                        <div class="btn-group-vertical w-100" role="group">
                            <input type="radio" class="btn-check" name="graphType" id="typeAll" value="all" checked>
                            <label class="btn btn-outline-primary" for="typeAll">
                                <i class="bi bi-diagram-3"></i> å®Œæ•´å›¾è°±
                            </label>
                            
                            <input type="radio" class="btn-check" name="graphType" id="typeCompany" value="company">
                            <label class="btn btn-outline-primary" for="typeCompany">
                                <i class="bi bi-building"></i> ä¼ä¸šå…³ç³»
                            </label>
                            
                            <input type="radio" class="btn-check" name="graphType" id="typeTech" value="technology">
                            <label class="btn btn-outline-primary" for="typeTech">
                                <i class="bi bi-cpu"></i> æŠ€æœ¯å…³ç³»
                            </label>
                            
                            <input type="radio" class="btn-check" name="graphType" id="typePolicy" value="policy">
                            <label class="btn btn-outline-primary" for="typePolicy">
                                <i class="bi bi-file-text"></i> æ”¿ç­–å…³ç³»
                            </label>
                        </div>

                        <button class="btn btn-primary w-100 mt-3" id="btnLoadGraph" disabled>
                            <i class="bi bi-play-circle"></i> åŠ è½½å›¾è°±
                        </button>

                        <div class="mt-4" id="statsPanel" style="display: none;">
                            <h6>å›¾è°±ç»Ÿè®¡</h6>
                            <table class="table table-sm">
                                <tr><td>èŠ‚ç‚¹æ•°</td><td id="nodeCount">-</td></tr>
                                <tr><td>å…³ç³»æ•°</td><td id="edgeCount">-</td></tr>
                                <tr><td>å®ä½“ç±»å‹</td><td id="typeCount">-</td></tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-9">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-diagram-3"></i> çŸ¥è¯†å›¾è°±å¯è§†åŒ–</h5>
                        <div id="graphContainer" style="height: 700px; border: 1px solid #ddd;"></div>
                    </div>
                </div>

                <div class="alert alert-info mt-3" id="instructions">
                    <strong><i class="bi bi-info-circle"></i> ä½¿ç”¨è¯´æ˜</strong>
                    <ul class="mb-0">
                        <li>ğŸ–±ï¸ æ‹–æ‹½èŠ‚ç‚¹ï¼šé‡æ–°æ’åˆ—å¸ƒå±€</li>
                        <li>ğŸ” ç¼©æ”¾ï¼šé¼ æ ‡æ»šè½®ç¼©æ”¾è§†å›¾</li>
                        <li>ğŸ’¡ ç‚¹å‡»èŠ‚ç‚¹ï¼šæŸ¥çœ‹å®ä½“è¯¦æƒ…</li>
                        <li>ğŸ”— æ‚¬åœè¿çº¿ï¼šæŸ¥çœ‹å…³ç³»ç±»å‹</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const reportSelect = document.getElementById('reportSelect');
        const btnLoadGraph = document.getElementById('btnLoadGraph');
        let currentChart = null;

        reportSelect.addEventListener('change', function() {
            btnLoadGraph.disabled = !this.value;
        });

        btnLoadGraph.addEventListener('click', async function() {
            const reportId = reportSelect.value;
            const graphType = document.querySelector('input[name="graphType"]:checked').value;
            
            if (!reportId) return;

            try {
                const url = `/api/report/${reportId}/knowledge-graph${graphType !== 'all' ? '?type=' + graphType : ''}`;
                const response = await fetch(url);
                const data = await response.json();
                
                renderGraph(data, reportId);
                updateStats(data);
                
            } catch (error) {
                alert('åŠ è½½çŸ¥è¯†å›¾è°±å¤±è´¥: ' + error.message);
            }
        });

        function renderGraph(data, reportId) {
            if (!currentChart) {
                currentChart = echarts.init(document.getElementById('graphContainer'));
            }
            
            if (data.graph_config) {
                currentChart.setOption(data.graph_config);
                // æº¯æºï¼šç‚¹å‡»èŠ‚ç‚¹æŸ¥è¯¢æ¥æºä¸Šä¸‹æ–‡
                currentChart.off('click');
                currentChart.on('click', async (params) => {
                    if (!params.name) return;
                    try {
                        const res = await fetch(`/api/report/${reportId}/source?query=` + encodeURIComponent(params.name));
                        const src = await res.json();
                        alert('æº¯æºç»“æœ\n' + (src.matches || []).join('\n\n'));
                    } catch (e) {}
                });
            } else {
                alert('å›¾è°±æ•°æ®ä¸ºç©º');
            }
        }

        function updateStats(data) {
            document.getElementById('statsPanel').style.display = 'block';
            document.getElementById('nodeCount').textContent = data.node_count || 0;
            document.getElementById('edgeCount').textContent = data.edge_count || 0;
            document.getElementById('typeCount').textContent = data.type_count || 0;
        }
    </script>
</body>
</html>
