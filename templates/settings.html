{% extends "base.html" %}

{% block title %}设置 - 区域产业分析小工作台{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="text-center mb-8">
        <h2 class="text-3xl font-bold text-gray-900 mb-4">
            <i class="fas fa-cog text-gray-500 mr-3"></i>系统设置
        </h2>
        <p class="text-lg text-gray-600">
            自定义分析类别和AI应用场景配置
        </p>
    </div>

    <!-- Settings Form -->
    <div class="bg-white rounded-lg shadow-lg p-8">
        <form id="settingsForm" class="space-y-8">
            <!-- Analysis Categories -->
            <div>
                <h3 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-layer-group text-blue-500 mr-2"></i>分析类别
                </h3>
                <p class="text-gray-600 mb-4">定义用于内容分类的分析维度</p>
                
                <div id="categoriesContainer" class="space-y-2">
                    <!-- Categories will be dynamically loaded -->
                </div>
                
                <button type="button" onclick="addCategory()" 
                        class="mt-4 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                    <i class="fas fa-plus mr-2"></i>添加类别
                </button>
            </div>

            <!-- AI Integration Focus Areas -->
            <div>
                <h3 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-robot text-purple-500 mr-2"></i>AI应用场景
                </h3>
                <p class="text-gray-600 mb-4">定义重点关注的AI技术应用领域</p>
                
                <div id="aiFocusContainer" class="space-y-2">
                    <!-- AI focus areas will be dynamically loaded -->
                </div>
                
                <button type="button" onclick="addAIFocus()" 
                        class="mt-4 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                    <i class="fas fa-plus mr-2"></i>添加AI场景
                </button>
            </div>

            <!-- Save Button -->
            <div class="text-center pt-6 border-t border-gray-200">
                <button type="submit" 
                        class="bg-blue-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                    <i class="fas fa-save mr-2"></i>保存设置
                </button>
                <button type="button" onclick="resetToDefault()" 
                        class="ml-4 bg-gray-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-gray-700 transition-colors">
                    <i class="fas fa-undo mr-2"></i>恢复默认
                </button>
            </div>
        </form>
    </div>

    <!-- Usage Tips -->
    <div class="mt-8 bg-blue-50 border-l-4 border-blue-400 p-6 rounded-lg">
        <h4 class="text-lg font-semibold text-blue-800 mb-3">
            <i class="fas fa-info-circle mr-2"></i>使用说明
        </h4>
        <div class="text-blue-700 space-y-2">
            <p><strong>分析类别:</strong> 用于自动分类上传文档的内容，建议使用具体、明确的类别名称</p>
            <p><strong>AI应用场景:</strong> 定义重点分析的AI技术应用领域，系统会根据这些场景分析文档中的相关机会</p>
            <p><strong>保存后生效:</strong> 配置修改后会立即应用到新的文档分析中</p>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-8 max-w-md mx-4 text-center">
        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mx-auto mb-4"></div>
        <h3 class="text-lg font-semibold text-gray-800 mb-2">保存设置中</h3>
        <p class="text-gray-600">请稍候...</p>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let currentConfig = {};

document.addEventListener('DOMContentLoaded', function() {
    loadConfiguration();
    
    document.getElementById('settingsForm').addEventListener('submit', saveConfiguration);
});

async function loadConfiguration() {
    try {
        showLoading();
        const response = await fetch('/api/config');
        const config = await response.json();
        
        currentConfig = config;
        renderCategories(config.categories || []);
        renderAIFocus(config.ai_integration_focus || []);
        
    } catch (error) {
        console.error('Error loading configuration:', error);
        alert('加载配置失败，请刷新页面重试');
    } finally {
        hideLoading();
    }
}

function renderCategories(categories) {
    const container = document.getElementById('categoriesContainer');
    container.innerHTML = '';
    
    categories.forEach((category, index) => {
        const categoryElement = createCategoryElement(category, index);
        container.appendChild(categoryElement);
    });
}

function renderAIFocus(aiFocus) {
    const container = document.getElementById('aiFocusContainer');
    container.innerHTML = '';
    
    aiFocus.forEach((focus, index) => {
        const focusElement = createAIFocusElement(focus, index);
        container.appendChild(focusElement);
    });
}

function createCategoryElement(category, index) {
    const div = document.createElement('div');
    div.className = 'flex items-center space-x-2 p-3 border border-gray-300 rounded-lg bg-gray-50';
    div.innerHTML = `
        <i class="fas fa-grip-vertical text-gray-400"></i>
        <input type="text" value="${category}" 
               class="flex-1 px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
               onchange="updateCategory(${index}, this.value)">
        <button type="button" onclick="removeCategory(${index})" 
                class="text-red-600 hover:text-red-800 p-2">
            <i class="fas fa-times"></i>
        </button>
    `;
    return div;
}

function createAIFocusElement(focus, index) {
    const div = document.createElement('div');
    div.className = 'flex items-center space-x-2 p-3 border border-gray-300 rounded-lg bg-gray-50';
    div.innerHTML = `
        <i class="fas fa-grip-vertical text-gray-400"></i>
        <input type="text" value="${focus}" 
               class="flex-1 px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-purple-500"
               onchange="updateAIFocus(${index}, this.value)">
        <button type="button" onclick="removeAIFocus(${index})" 
                class="text-red-600 hover:text-red-800 p-2">
            <i class="fas fa-times"></i>
        </button>
    `;
    return div;
}

function addCategory() {
    currentConfig.categories = currentConfig.categories || [];
    currentConfig.categories.push('新类别');
    renderCategories(currentConfig.categories);
}

function addAIFocus() {
    currentConfig.ai_integration_focus = currentConfig.ai_integration_focus || [];
    currentConfig.ai_integration_focus.push('新AI场景');
    renderAIFocus(currentConfig.ai_integration_focus);
}

function updateCategory(index, value) {
    if (currentConfig.categories && currentConfig.categories[index] !== undefined) {
        currentConfig.categories[index] = value;
    }
}

function updateAIFocus(index, value) {
    if (currentConfig.ai_integration_focus && currentConfig.ai_integration_focus[index] !== undefined) {
        currentConfig.ai_integration_focus[index] = value;
    }
}

function removeCategory(index) {
    if (currentConfig.categories && currentConfig.categories[index] !== undefined) {
        currentConfig.categories.splice(index, 1);
        renderCategories(currentConfig.categories);
    }
}

function removeAIFocus(index) {
    if (currentConfig.ai_integration_focus && currentConfig.ai_integration_focus[index] !== undefined) {
        currentConfig.ai_integration_focus.splice(index, 1);
        renderAIFocus(currentConfig.ai_integration_focus);
    }
}

async function saveConfiguration(event) {
    event.preventDefault();
    
    try {
        showLoading();
        
        const response = await fetch('/api/config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(currentConfig)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('设置保存成功！');
        } else {
            alert('保存失败: ' + (result.error || '未知错误'));
        }
        
    } catch (error) {
        console.error('Error saving configuration:', error);
        alert('保存设置失败，请重试');
    } finally {
        hideLoading();
    }
}

async function resetToDefault() {
    if (confirm('确定要恢复默认设置吗？此操作将覆盖您的自定义配置。')) {
        const defaultConfig = {
            categories: [
                "产业概述", "政策环境", "市场规模", "重点企业",
                "技术趋势", "发展机遇", "挑战风险", "未来展望"
            ],
            ai_integration_focus: [
                "智能制造", "数据分析", "自动化流程", "预测性维护",
                "供应链优化", "客户服务", "质量控制"
            ]
        };
        
        currentConfig = defaultConfig;
        renderCategories(currentConfig.categories);
        renderAIFocus(currentConfig.ai_integration_focus);
        
        // Save the default configuration
        await saveConfiguration(new Event('submit'));
    }
}

function showLoading() {
    document.getElementById('loadingOverlay').classList.remove('hidden');
}

function hideLoading() {
    document.getElementById('loadingOverlay').classList.add('hidden');
}
</script>
{% endblock %}