{% extends "base.html" %}

{% block title %}上传分析 - 区域产业分析小工作台{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="text-center mb-8">
        <h2 class="text-3xl font-bold text-gray-900 mb-4">
            <i class="fas fa-upload text-blue-500 mr-3"></i>上传文件进行分析
        </h2>
        <p class="text-lg text-gray-600">
            上传产业分析报告，系统将自动进行产业分析
        </p>
    </div>

    <!-- Upload Form -->
    <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
        <form method="POST" enctype="multipart/form-data" class="space-y-6" id="uploadForm">
            <!-- File Upload Area -->
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 transition-colors" 
                 id="dropZone">
                <input type="file" name="file" id="fileInput" class="hidden" accept=".txt,.md,.json,.docx,.pdf">
                
                <div id="uploadPrompt">
                    <i class="fas fa-cloud-upload-alt text-6xl text-gray-400 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">点击上传或拖拽文件到这里</h3>
                    <p class="text-gray-500 mb-4">支持 .txt, .md, .json, .docx, .pdf 格式</p>
                    <button type="button" onclick="document.getElementById('fileInput').click()" 
                            class="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                        <i class="fas fa-folder-open mr-2"></i>选择文件
                    </button>
                </div>

                <div id="filePreview" class="hidden">
                    <div class="flex items-center justify-center space-x-4">
                        <i class="fas fa-file-alt text-4xl text-green-500"></i>
                        <div class="text-left">
                            <div class="font-semibold text-gray-800" id="fileName"></div>
                            <div class="text-sm text-gray-500" id="fileSize"></div>
                        </div>
                        <button type="button" onclick="clearFile()" 
                                class="text-red-500 hover:text-red-700">
                            <i class="fas fa-times-circle text-2xl"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Processing Options -->
            <div class="bg-gray-50 rounded-lg p-6">
                <h4 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-cog text-gray-600 mr-2"></i>分析选项
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" checked class="mr-2" name="analyze_categories">
                            <span class="text-gray-700">按类别分析内容</span>
                        </label>
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" checked class="mr-2" name="extract_keywords">
                            <span class="text-gray-700">提取关键词</span>
                        </label>
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" checked class="mr-2" name="ai_opportunities">
                            <span class="text-gray-700">分析AI应用机会</span>
                        </label>
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" checked class="mr-2" name="generate_charts">
                            <span class="text-gray-700">生成可视化图表</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="text-center">
                <button type="submit" 
                        class="bg-green-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-green-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
                        id="submitBtn" disabled>
                    <i class="fas fa-rocket mr-2"></i>开始分析
                </button>
            </div>
        </form>
    </div>

    <!-- Loading Indicator -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-md mx-4 text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <h3 class="text-lg font-semibold text-gray-800 mb-2">正在分析文件</h3>
            <p class="text-gray-600">请稍候，系统正在处理您的文件...</p>
        </div>
    </div>

    <!-- File Format Guidelines -->
    <div class="bg-blue-50 border-l-4 border-blue-400 p-6 rounded-lg">
        <h4 class="text-lg font-semibold text-blue-800 mb-3">
            <i class="fas fa-info-circle mr-2"></i>文件格式说明
        </h4>
        <div class="text-blue-700 space-y-2">
            <p><strong>.txt/.md:</strong> 纯文本文件，推荐用于产业分析报告的文本输出</p>
            <p><strong>.json:</strong> 结构化数据文件，支持复杂的数据格式</p>
            <p><strong>.docx:</strong> Word 文档，提取文本内容进行分析</p>
            <p><strong>.pdf:</strong> PDF 文件，自动提取文本内容</p>
        </div>
    </div>

    <!-- Tips -->
    <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-green-50 rounded-lg p-6">
            <h4 class="text-lg font-semibold text-green-800 mb-3">
                <i class="fas fa-lightbulb text-green-600 mr-2"></i>使用建议
            </h4>
            <ul class="text-green-700 space-y-1">
                <li>• 确保文件内容包含完整的产业分析信息</li>
                <li>• 中文内容分析效果更佳</li>
                <li>• 文件大小建议不超过 16MB</li>
                <li>• 结构化的内容有助于提高分析准确性</li>
            </ul>
        </div>

        <div class="bg-yellow-50 rounded-lg p-6">
            <h4 class="text-lg font-semibold text-yellow-800 mb-3">
                <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>注意事项
            </h4>
            <ul class="text-yellow-700 space-y-1">
                <li>• 确保文件内容符合分析目标</li>
                <li>• 避免上传包含敏感信息的文件</li>
                <li>• 分析时间取决于文件大小和复杂度</li>
                <li>• 建议在稳定网络环境下使用</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('dropZone');
    const uploadPrompt = document.getElementById('uploadPrompt');
    const filePreview = document.getElementById('filePreview');
    const submitBtn = document.getElementById('submitBtn');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const uploadForm = document.getElementById('uploadForm');

    // File input change handler
    fileInput.addEventListener('change', handleFileSelect);

    // Drag and drop handlers
    dropZone.addEventListener('dragover', handleDragOver);
    dropZone.addEventListener('drop', handleDrop);
    dropZone.addEventListener('dragleave', handleDragLeave);

    // Form submit handler
    uploadForm.addEventListener('submit', handleFormSubmit);

    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
            displayFilePreview(file);
        }
    }

    function handleDragOver(event) {
        event.preventDefault();
        dropZone.classList.add('border-blue-400', 'bg-blue-50');
    }

    function handleDragLeave(event) {
        event.preventDefault();
        dropZone.classList.remove('border-blue-400', 'bg-blue-50');
    }

    function handleDrop(event) {
        event.preventDefault();
        dropZone.classList.remove('border-blue-400', 'bg-blue-50');
        
        const files = event.dataTransfer.files;
        if (files.length > 0) {
            const file = files[0];
            
            // Check file type
            const allowedTypes = ['.txt', '.md', '.json', '.docx', '.pdf'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            
            if (allowedTypes.includes(fileExtension)) {
                fileInput.files = files;
                displayFilePreview(file);
            } else {
                alert('不支持的文件格式。请上传 .txt, .md, .json, .docx 或 .pdf 文件。');
            }
        }
    }

    function displayFilePreview(file) {
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');

        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);

        uploadPrompt.classList.add('hidden');
        filePreview.classList.remove('hidden');
        submitBtn.disabled = false;
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function clearFile() {
        fileInput.value = '';
        uploadPrompt.classList.remove('hidden');
        filePreview.classList.add('hidden');
        submitBtn.disabled = true;
    }

    function handleFormSubmit(event) {
        // Show loading overlay
        loadingOverlay.classList.remove('hidden');
    }

    // Make clearFile globally accessible
    window.clearFile = clearFile;
});
</script>
{% endblock %}