<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>政策解析与脑图可视化</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --accent-color: #4cc9f0;
            --success-color: #4ade80;
            --warning-color: #facc15;
            --danger-color: #f87171;
            --dark-bg: #0f172a;
            --card-bg: #ffffff;
            --sidebar-bg: #1e293b;
            --hover-bg: #f1f5f9;
        }
        
        body {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: #1e293b;
            overflow-x: hidden;
        }
        
        .navbar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .main-content {
            margin-top: 20px;
            padding: 20px;
        }
        
        .policy-header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
            border: 1px solid #e2e8f0;
        }
        
        .analysis-section {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            border: 1px solid #e2e8f0;
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f5f9;
        }
        
        .brain-map-container {
            height: 600px;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            border: 1px solid #e2e8f0;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(67, 97, 238, 0.15);
        }
        
        .metric-number {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 10px 0;
        }
        
        .metric-label {
            color: #64748b;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .chart-container {
            height: 400px;
            margin: 20px 0;
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        
        .content-section {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .tag {
            display: inline-block;
            padding: 6px 12px;
            margin: 4px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .region-tag { background: #dbeafe; color: #1e40af; }
        .industry-tag { background: #dcfce7; color: #166534; }
        .year-tag { background: #fef3c7; color: #92400e; }
        .type-tag { background: #ede9fe; color: #6d28d9; }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            flex-direction: column;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .node-detail-panel {
            position: fixed;
            right: 20px;
            top: 80px;
            width: 350px;
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            z-index: 1000;
            border: 1px solid #e2e8f0;
        }
        
        .node-detail-panel h6 {
            color: var(--primary-color);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(67, 97, 238, 0.3);
        }
        
        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid px-4">
            <a class="navbar-brand d-flex align-items-center" href="{{ url_for('index') }}">
                <i class="fas fa-brain me-2"></i>
                <span class="fw-bold">政策分析平台</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('index') }}"><i class="fas fa-home me-1"></i>首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('generate_report') }}"><i class="fas fa-file-alt me-1"></i>报告生成</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('policy_analysis_dashboard') }}">政策解读</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user me-2"></i>{{ current_user.username }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt me-2 text-danger"></i>退出登录</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="back-button">
        <a href="{{ url_for('policy_analysis_dashboard') }}" class="btn btn-outline-light">
            <i class="fas fa-arrow-left me-1"></i>返回列表
        </a>
    </div>

    <div class="main-content container-fluid">
        <!-- Policy Header -->
        <div class="policy-header">
            <h1 class="text-center mb-3">
                <span id="policyTitle" style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">政策标题</span>
            </h1>
            <div class="text-center mb-4">
                <span class="tag region-tag" id="policyRegion">区域</span>
                <span class="tag industry-tag" id="policyIndustry">行业</span>
                <span class="tag year-tag" id="policyYear">年份</span>
                <span class="tag type-tag" id="policyType">类型</span>
            </div>
            <div class="row text-center">
                <div class="col-md-3">
                    <div class="metric-number" id="policyScore">0</div>
                    <div class="metric-label">适用性评分</div>
                </div>
                <div class="col-md-3">
                    <div class="metric-number" id="totalFunding">0</div>
                    <div class="metric-label">总资金支持</div>
                </div>
                <div class="col-md-3">
                    <div class="metric-number" id="supportTypes">0</div>
                    <div class="metric-label">支持类型</div>
                </div>
                <div class="col-md-3">
                    <div class="metric-number" id="applicableCount">0</div>
                    <div class="metric-label">适用对象</div>
                </div>
            </div>
        </div>

        <!-- Analysis Metrics -->
        <div class="analysis-section">
            <h3 class="section-title"><i class="fas fa-tachometer-alt me-2"></i>政策分析指标</h3>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-number" id="keyPointsCount">0</div>
                    <div class="metric-label">政策要点</div>
                </div>
                <div class="metric-card">
                    <div class="metric-number" id="fundingAmount">0</div>
                    <div class="metric-label">资金总额</div>
                </div>
                <div class="metric-card">
                    <div class="metric-number" id="subsidyCount">0</div>
                    <div class="metric-label">补贴项目</div>
                </div>
                <div class="metric-card">
                    <div class="metric-number" id="deadlineCount">0</div>
                    <div class="metric-label">关键节点</div>
                </div>
            </div>
        </div>

        <!-- Brain Map Visualization -->
        <div class="analysis-section">
            <h3 class="section-title"><i class="fas fa-project-diagram me-2"></i>政策脑图</h3>
            <div id="brainMapChart" class="brain-map-container"></div>
        </div>

        <!-- Detailed Analysis -->
        <div class="row">
            <div class="col-md-6">
                <div class="analysis-section">
                    <h3 class="section-title"><i class="fas fa-coins me-2"></i>资金支持</h3>
                    <div id="fundingDetails" class="content-section">
                        <div class="text-muted text-center py-4">正在加载资金支持信息...</div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="analysis-section">
                    <h3 class="section-title"><i class="fas fa-users me-2"></i>适用对象</h3>
                    <div id="applicableDetails" class="content-section">
                        <div class="text-muted text-center py-4">正在加载适用对象信息...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="analysis-section">
                    <h3 class="section-title"><i class="fas fa-calendar-alt me-2"></i>时间节点</h3>
                    <div id="timelineDetails" class="content-section">
                        <div class="text-muted text-center py-4">正在加载时间节点信息...</div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="analysis-section">
                    <h3 class="section-title"><i class="fas fa-bullseye me-2"></i>政策目标</h3>
                    <div id="goalsDetails" class="content-section">
                        <div class="text-muted text-center py-4">正在加载政策目标信息...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Original Content -->
        <div class="analysis-section">
            <h3 class="section-title"><i class="fas fa-file-alt me-2"></i>原始内容</h3>
            <div id="originalContent" class="content-section">
                <div class="text-muted text-center py-4">正在加载原始内容...</div>
            </div>
        </div>
    </div>

    <!-- Node Detail Panel -->
    <div class="node-detail-panel" id="nodeDetailPanel" style="display: none;">
        <h6><i class="fas fa-info-circle me-2"></i>节点详情</h6>
        <div id="nodeDetailContent">
            <!-- Node details will be populated here -->
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <h5>正在分析政策内容...</h5>
        <p class="text-muted">使用大语言模型进行深度解读</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentNodeData = null;
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            loadPolicyAnalysis();
        });
        
        async function loadPolicyAnalysis() {
            // Simulate loading for demo purposes
            // In real implementation, this would fetch from the backend
            setTimeout(() => {
                simulatePolicyAnalysis();
            }, 1500);
        }
        
        function simulatePolicyAnalysis() {
            // Hide loading overlay
            document.getElementById('loadingOverlay').style.display = 'none';
            
            // Simulate policy data
            const policyData = {
                title: "成都市人民政府关于支持人工智能产业发展的若干政策措施",
                region: "成都市",
                industry: "人工智能",
                year: "2024",
                policyType: "扶持政策",
                score: 85,
                totalFunding: "5亿",
                supportTypes: 8,
                applicableCount: 12,
                keyPoints: 15,
                fundingAmount: "50000",
                subsidyCount: 7,
                deadlineCount: 5
            };
            
            // Update header
            document.getElementById('policyTitle').textContent = policyData.title;
            document.getElementById('policyRegion').textContent = policyData.region;
            document.getElementById('policyIndustry').textContent = policyData.industry;
            document.getElementById('policyYear').textContent = policyData.year + "年";
            document.getElementById('policyType').textContent = policyData.policyType;
            document.getElementById('policyScore').textContent = policyData.score;
            document.getElementById('totalFunding').textContent = policyData.totalFunding;
            document.getElementById('supportTypes').textContent = policyData.supportTypes;
            document.getElementById('applicableCount').textContent = policyData.applicableCount;
            
            // Update metrics
            document.getElementById('keyPointsCount').textContent = policyData.keyPoints;
            document.getElementById('fundingAmount').textContent = policyData.fundingAmount;
            document.getElementById('subsidyCount').textContent = policyData.subsidyCount;
            document.getElementById('deadlineCount').textContent = policyData.deadlineCount;
            
            // Simulate detailed content
            document.getElementById('fundingDetails').innerHTML = `
                <ul class="list-unstyled">
                    <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>设立人工智能产业发展专项资金，每年安排不少于5亿元</li>
                    <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>对新引进的头部人工智能企业给予最高2000万元一次性奖励</li>
                    <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>对年营业收入首次突破1000万元、5000万元、1亿元的企业分别给予30万、80万、200万元奖励</li>
                    <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>对高新技术企业减按15%税率征收企业所得税</li>
                    <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>对企业研发费用加计扣除比例提高至200%</li>
                </ul>
            `;
            
            document.getElementById('applicableDetails').innerHTML = `
                <ul class="list-unstyled">
                    <li class="mb-2"><i class="fas fa-user-tie text-primary me-2"></i>在成都市注册的人工智能企业</li>
                    <li class="mb-2"><i class="fas fa-building text-primary me-2"></i>具有独立法人资格的企业</li>
                    <li class="mb-2"><i class="fas fa-chart-line text-primary me-2"></i>年营业收入不低于1000万元</li>
                    <li class="mb-2"><i class="fas fa-graduation-cap text-primary me-2"></i>拥有核心技术知识产权</li>
                    <li class="mb-2"><i class="fas fa-industry text-primary me-2"></i>属于重点支持的人工智能细分领域</li>
                </ul>
            `;
            
            document.getElementById('timelineDetails').innerHTML = `
                <div class="timeline">
                    <div class="timeline-item mb-3">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-calendar-check text-success me-2"></i>
                            <strong>发布日期:</strong>
                        </div>
                        <div class="ms-4 text-muted">2024年1月15日</div>
                    </div>
                    <div class="timeline-item mb-3">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-play-circle text-info me-2"></i>
                            <strong>实施日期:</strong>
                        </div>
                        <div class="ms-4 text-muted">2024年2月1日</div>
                    </div>
                    <div class="timeline-item mb-3">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-hourglass-end text-warning me-2"></i>
                            <strong>申报截止:</strong>
                        </div>
                        <div class="ms-4 text-muted">2024年12月31日</div>
                    </div>
                    <div class="timeline-item mb-3">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-clock text-secondary me-2"></i>
                            <strong>政策有效期:</strong>
                        </div>
                        <div class="ms-4 text-muted">2024年2月1日 至 2025年12月31日</div>
                    </div>
                </div>
            `;
            
            document.getElementById('goalsDetails').innerHTML = `
                <ul class="list-unstyled">
                    <li class="mb-2"><i class="fas fa-bullseye text-success me-2"></i>到2025年，全市人工智能核心产业规模达到500亿元</li>
                    <li class="mb-2"><i class="fas fa-users text-success me-2"></i>培育100家以上人工智能企业</li>
                    <li class="mb-2"><i class="fas fa-lightbulb text-success me-2"></i>打造人工智能创新发展示范区</li>
                    <li class="mb-2"><i class="fas fa-cogs text-success me-2"></i>构建人工智能产业生态圈</li>
                    <li class="mb-2"><i class="fas fa-rocket text-success me-2"></i>推动传统产业智能化转型升级</li>
                </ul>
            `;
            
            document.getElementById('originalContent').innerHTML = `
                <h5>政策原文片段</h5>
                <p>为贯彻落实国家人工智能发展战略，加快推动我市人工智能产业高质量发展，特制定以下政策措施：</p>
                
                <h6>一、资金支持</h6>
                <p>设立人工智能产业发展专项资金，每年安排不少于5亿元。对新引进的头部人工智能企业给予最高2000万元一次性奖励。</p>
                
                <h6>二、税收优惠</h6>
                <p>对符合条件的人工智能企业，减按15%税率征收企业所得税。对企业研发费用加计扣除比例提高至200%。</p>
                
                <h6>三、人才政策</h6>
                <p>对引进的顶尖人才给予最高1000万元安家费，对硕博士研究生给予生活补贴。</p>
                
                <h6>四、申报条件</h6>
                <p>在成都市注册、具有独立法人资格、年营业收入不低于1000万元的人工智能企业可申报相关支持政策。</p>
            `;
            
            // Create brain map visualization
            createBrainMap();
        }
        
        function createBrainMap() {
            const brainMapChart = echarts.init(document.getElementById('brainMapChart'));
            
            // Brain map data for the policy
            const brainMapData = {
                title: "成都市人工智能产业支持政策",
                children: [
                    {
                        name: "政策背景",
                        children: [
                            { name: "国家战略部署", value: 100 },
                            { name: "区域发展目标", value: 95 },
                            { name: "产业现状分析", value: 90 }
                        ]
                    },
                    {
                        name: "资金支持",
                        children: [
                            { name: "专项资金", value: 200, description: "每年不少于5亿元" },
                            { name: "企业奖励", value: 150, description: "最高2000万元" },
                            { name: "营收奖励", value: 120, description: "1000万/5000万/1亿元档位" },
                            { name: "税收优惠", value: 100, description: "15%税率，200%研发费加计" }
                        ]
                    },
                    {
                        name: "适用对象",
                        children: [
                            { name: "企业类型", value: 140, description: "人工智能企业" },
                            { name: "注册要求", value: 100, description: "成都市内注册" },
                            { name: "营收门槛", value: 90, description: "不低于1000万元" },
                            { name: "资质要求", value: 80, description: "独立法人资格" }
                        ]
                    },
                    {
                        name: "时间节点",
                        children: [
                            { name: "发布时间", value: 100, description: "2024年1月15日" },
                            { name: "实施时间", value: 100, description: "2024年2月1日" },
                            { name: "申报截止", value: 85, description: "2024年12月31日" },
                            { name: "政策期限", value: 80, description: "至2025年12月31日" }
                        ]
                    },
                    {
                        name: "政策目标",
                        children: [
                            { name: "产业规模", value: 180, description: "500亿元目标" },
                            { name: "企业培育", value: 150, description: "100家企业" },
                            { name: "创新发展", value: 120, description: "示范区建设" },
                            { name: "转型升级", value: 100, description: "传统产业升级" }
                        ]
                    },
                    {
                        name: "实施保障",
                        children: [
                            { name: "组织保障", value: 90 },
                            { name: "监督评估", value: 85 },
                            { name: "宣传推广", value: 80 },
                            { name: "咨询服务", value: 75 }
                        ]
                    }
                ]
            };
            
            const option = {
                title: {
                    text: '政策解析脑图',
                    left: 'center',
                    textStyle: {
                        fontSize: 18,
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    trigger: 'item',
                    triggerOn: 'mousemove',
                    formatter: function(params) {
                        if (params.data.description) {
                            return params.name + '<br/>' + params.data.description;
                        }
                        return params.name;
                    }
                },
                series: [
                    {
                        type: 'tree',
                        data: [brainMapData],
                        top: '5%',
                        left: '10%',
                        bottom: '5%',
                        right: '10%',
                        symbolSize: 15,
                        label: {
                            position: 'left',
                            verticalAlign: 'middle',
                            align: 'right',
                            fontSize: 14
                        },
                        leaves: {
                            label: {
                                position: 'right',
                                verticalAlign: 'middle',
                                align: 'left'
                            }
                        },
                        expandAndCollapse: true,
                        animationDuration: 550,
                        animationEasingUpdate: 'quinticInOut',
                        emphasis: {
                            focus: 'descendant'
                        }
                    }
                ]
            };
            
            brainMapChart.setOption(option);
            
            // Add click event to nodes
            brainMapChart.on('click', function(params) {
                if (params.data && params.data.name) {
                    showNodeDetail(params.data, params.event.offsetX, params.event.offsetY);
                }
            });
            
            // Make chart responsive
            window.addEventListener('resize', function() {
                brainMapChart.resize();
            });
        }
        
        function showNodeDetail(nodeData, x, y) {
            currentNodeData = nodeData;
            const panel = document.getElementById('nodeDetailPanel');
            const content = document.getElementById('nodeDetailContent');
            
            let detailHtml = `<h6>${nodeData.name}</h6>`;
            
            if (nodeData.description) {
                detailHtml += `<p class="text-muted">${nodeData.description}</p>`;
            }
            
            if (nodeData.value) {
                detailHtml += `<p class="text-success"><strong>重要度: ${nodeData.value}</strong></p>`;
            }
            
            // Add more details based on node type
            if (nodeData.name.includes('资金') || nodeData.name.includes('支持')) {
                detailHtml += `
                    <h6 class="mt-3">相关措施:</h6>
                    <ul class="list-unstyled">
                        <li class="mb-1"><i class="fas fa-check-circle text-success me-2"></i>专项资金设立</li>
                        <li class="mb-1"><i class="fas fa-check-circle text-success me-2"></i>企业奖励机制</li>
                        <li class="mb-1"><i class="fas fa-check-circle text-success me-2"></i>税收优惠政策</li>
                    </ul>
                `;
            } else if (nodeData.name.includes('适用') || nodeData.name.includes('对象')) {
                detailHtml += `
                    <h6 class="mt-3">具体要求:</h6>
                    <ul class="list-unstyled">
                        <li class="mb-1"><i class="fas fa-user-check text-info me-2"></i>企业资质</li>
                        <li class="mb-1"><i class="fas fa-dollar-sign text-info me-2"></i>营收门槛</li>
                        <li class="mb-1"><i class="fas fa-map-marker text-info me-2"></i>地区要求</li>
                    </ul>
                `;
            } else if (nodeData.name.includes('节点') || nodeData.name.includes('时间')) {
                detailHtml += `
                    <h6 class="mt-3">时间安排:</h6>
                    <ul class="list-unstyled">
                        <li class="mb-1"><i class="fas fa-calendar text-warning me-2"></i>发布: 已完成</li>
                        <li class="mb-1"><i class="fas fa-play-circle text-warning me-2"></i>实施: 进行中</li>
                        <li class="mb-1"><i class="fas fa-hourglass-end text-warning me-2"></i>申报截止: 倒计时</li>
                    </ul>
                `;
            }
            
            content.innerHTML = detailHtml;
            panel.style.display = 'block';
            
            // Position the panel near the mouse but make sure it stays in view
            const rect = panel.getBoundingClientRect();
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            
            let leftPos = x + 20;
            let topPos = y - rect.height / 2;
            
            // Adjust if going outside viewport
            if (leftPos + rect.width > windowWidth) {
                leftPos = x - rect.width - 10;
            }
            
            if (topPos < 0) {
                topPos = 10;
            } else if (topPos + rect.height > windowHeight) {
                topPos = windowHeight - rect.height - 10;
            }
            
            panel.style.left = leftPos + 'px';
            panel.style.top = topPos + 'px';
        }
        
        // Close node detail panel when clicking elsewhere
        document.addEventListener('click', function(event) {
            const panel = document.getElementById('nodeDetailPanel');
            const brainMapChart = document.getElementById('brainMapChart');
            
            if (!panel.contains(event.target) && !brainMapChart.contains(event.target)) {
                panel.style.display = 'none';
            }
        });
        
        // Add keyboard shortcut to close panel (ESC key)
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                document.getElementById('nodeDetailPanel').style.display = 'none';
            }
        });
        
        // Function to download the brain map as image
        function downloadBrainMap() {
            const chartDom = document.getElementById('brainMapChart');
            const canvas = chartDom.querySelector('canvas');
            if (canvas) {
                const link = document.createElement('a');
                link.download = 'policy-brain-map.png';
                link.href = canvas.toDataURL();
                link.click();
            }
        }
    </script>
</body>
</html>