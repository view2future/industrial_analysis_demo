<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”ŸæˆAIæŠ¥å‘Š - åŒºåŸŸäº§ä¸šåˆ†æå°å·¥ä½œå°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
        }
        body {
            background-color: #f8f9fa;
        }
        .navbar {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar-brand, .nav-link {
            color: white !important;
        }
        .page-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 40px 0;
            margin-bottom: 40px;
        }
        .form-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            padding: 40px;
        }
        .example-box {
            background-color: #f8f9fa;
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            margin-top: 10px;
        }
        .btn-generate {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border: none;
            padding: 12px 40px;
            font-size: 18px;
        }
        .btn-generate:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                ğŸ­ åŒºåŸŸäº§ä¸šåˆ†æç³»ç»Ÿ
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('index') }}"><i class="bi bi-house-door"></i> è¿”å›é¦–é¡µ</a>
            </div>
        </div>
    </nav>

    <!-- Page Header -->
    <div class="page-header">
        <div class="container text-center">
            <h1><i class="bi bi-robot"></i> AIæ™ºèƒ½æŠ¥å‘Šç”Ÿæˆ</h1>
            <p class="lead">æ”¯æŒå¤šç§LLMï¼Œè‡ªåŠ¨ç”Ÿæˆä¸“ä¸šçš„åŒºåŸŸäº§ä¸šåˆ†ææŠ¥å‘Š</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mb-5">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card form-card">
                    <h3 class="mb-4"><i class="bi bi-file-earmark-text"></i> å¡«å†™æŠ¥å‘Šä¿¡æ¯</h3>
                    
                    <form method="POST" action="{{ url_for('generate_report') }}" id="generateForm">
                        <div class="mb-4">
                            <label for="city" class="form-label">
                                <strong>ç›®æ ‡åŸå¸‚ <span class="text-danger">*</span></strong>
                            </label>
                            <input type="text" class="form-control form-control-lg" id="city" name="city" 
                                   placeholder="ä¾‹å¦‚ï¼šæˆéƒ½ã€é‡åº†ã€è¥¿å®‰" required>
                            <div class="example-box">
                                <strong>ç¤ºä¾‹ï¼š</strong>æˆéƒ½ã€é‡åº†ã€è¥¿å®‰ã€åŒ—äº¬ã€ä¸Šæµ·ã€æ·±åœ³ã€æ­å·ã€æ­¦æ±‰ã€é•¿æ²™ã€éƒ‘å·
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="industry" class="form-label">
                                <strong>ç›®æ ‡è¡Œä¸š <span class="text-danger">*</span></strong>
                            </label>
                            <input type="text" class="form-control form-control-lg" id="industry" name="industry" 
                                   placeholder="ä¾‹å¦‚ï¼šäººå·¥æ™ºèƒ½ã€æ±½è½¦äº§ä¸šã€ç”Ÿç‰©åŒ»è¯" required>
                            <div class="example-box">
                                <strong>ç¤ºä¾‹ï¼š</strong>äººå·¥æ™ºèƒ½ã€æ±½è½¦äº§ä¸šã€ç”Ÿç‰©åŒ»è¯ã€é›†æˆç”µè·¯ã€æ–°èƒ½æºã€å…ˆè¿›åˆ¶é€ ã€æ•°å­—ç»æµã€æ–‡åŒ–åˆ›æ„
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="llm_service" class="form-label">
                                <strong>é€‰æ‹©å¤§è¯­è¨€æ¨¡å‹æœåŠ¡ <span class="text-danger">*</span></strong>
                            </label>
                            <select class="form-select form-select-lg" id="llm_service" name="llm_service">
                                <option value="kimi" selected>Kimiï¼ˆæ¨èï¼Œå·²é…ç½®ï¼‰</option>
                                <option value="gemini">Google Geminiï¼ˆå·²é…ç½®ï¼‰</option>
                                <option value="doubao">è±†åŒ…å¤§æ¨¡å‹ï¼ˆå·²é…ç½®ï¼‰</option>
                            </select>
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i> é»˜è®¤ä½¿ç”¨Kimiã€‚è¯·ç¡®ä¿å·²åœ¨config.jsonä¸­é…ç½®ç›¸åº”API Key
                            </small>
                        </div>

                        <div class="mb-4">
                            <label for="additional_context" class="form-label">
                                <strong>è¡¥å……ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰</strong>
                            </label>
                            <textarea class="form-control" id="additional_context" name="additional_context" 
                                      rows="5" placeholder="ä¾‹å¦‚ï¼šè¯·é‡ç‚¹åˆ†æè¯¥è¡Œä¸šçš„æŠ€æœ¯åˆ›æ–°èƒ½åŠ›ã€å¸‚åœºè§„æ¨¡è¶‹åŠ¿ã€æ”¿ç­–æ”¯æŒåŠ›åº¦ç­‰..."></textarea>
                            <small class="text-muted">
                                æ‚¨å¯ä»¥åœ¨è¿™é‡Œè¡¥å……ä»»ä½•ç‰¹æ®Šè¦æ±‚æˆ–å…³æ³¨ç‚¹ï¼ŒAIå°†æ ¹æ®æ‚¨çš„éœ€æ±‚è°ƒæ•´æŠ¥å‘Šå†…å®¹
                            </small>
                        </div>

                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> <strong>æ¸©é¦¨æç¤ºï¼š</strong>
                            <ul class="mb-0 mt-2">
                                <li>æŠ¥å‘Šç”Ÿæˆéœ€è¦2-5åˆ†é’Ÿï¼Œç³»ç»Ÿå°†åœ¨åå°å¤„ç†</li>
                                <li>ç”Ÿæˆè¿‡ç¨‹ä¸­æ‚¨å¯ä»¥æŸ¥çœ‹å®æ—¶è¿›åº¦</li>
                                <li>å®Œæˆåç³»ç»Ÿä¼šè‡ªåŠ¨è·³è½¬åˆ°æŠ¥å‘Šé¡µé¢</li>
                                <li>æŠ¥å‘Šå°†åŒ…å«ï¼šæ‰§è¡Œæ‘˜è¦ã€äº§ä¸šæ¦‚è§ˆã€æ”¿ç­–åˆ†æã€ç”Ÿæ€åˆ†æã€äº§ä¸šé“¾åˆ†æã€AIèåˆå»ºè®®ç­‰å†…å®¹</li>
                            </ul>
                        </div>

                        <div class="mb-4">
                            <div class="form-check">
<input class="form-check-input" type="checkbox" id="use_streaming" name="use_streaming" value="1" checked>
                                <label class="form-check-label" for="use_streaming">
                                    <strong>å¯ç”¨æµå¼ç”Ÿæˆ</strong> - å®æ—¶è§‚çœ‹AIç”Ÿæˆå†…å®¹
                                </label>
                            </div>
                            <small class="text-muted">
                                <i class="bi bi-lightning"></i> æµå¼ç”Ÿæˆè®©æ‚¨å®æ—¶çœ‹åˆ°AIç”Ÿæˆçš„å†…å®¹ï¼Œæä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ
                            </small>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                            <button type="submit" class="btn btn-primary btn-generate">
                                <i class="bi bi-magic"></i> å¼€å§‹ç”ŸæˆæŠ¥å‘Š
                            </button>
                            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-lg">
                                <i class="bi bi-x-circle"></i> å–æ¶ˆ
                            </a>
                        </div>

                        <div id="streamContainer" class="card mt-4" style="display: none;">
                          <div class="card-body">
                            <h5 class="card-title"><i class="bi bi-lightning"></i> å®æ—¶ç”Ÿæˆå†…å®¹</h5>
                            <pre id="streamOutput" class="p-3 bg-light" style="height: 300px; overflow:auto;"></pre>
                          </div>
                        </div>
                    </form>
                </div>

                <!-- Info Cards -->
                <div class="row mt-4">
                    <div class="col-md-4 mb-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="bi bi-speedometer2" style="font-size: 36px; color: var(--primary-color);"></i>
                                <h6 class="mt-2">å¿«é€Ÿç”Ÿæˆ</h6>
                                <p class="text-muted small">2-5åˆ†é’Ÿå®Œæˆ</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="bi bi-stars" style="font-size: 36px; color: var(--primary-color);"></i>
                                <h6 class="mt-2">ä¸“ä¸šå†…å®¹</h6>
                                <p class="text-muted small">7å¤§æ ¸å¿ƒæ¨¡å—</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="bi bi-translate" style="font-size: 36px; color: var(--primary-color);"></i>
                                <h6 class="mt-2">åŒè¯­æ‘˜è¦</h6>
                                <p class="text-muted small">ä¸­è‹±æ–‡æ”¯æŒ</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Modal -->
    <div class="modal fade" id="progressModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-xl" style="position: fixed; top: 20px; right: 20px; width: 500px; margin: 0; max-width: 500px;">
            <div class="modal-content" style="height: 600px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
                <div class="modal-header bg-gradient" style="background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); padding: 10px 15px;">
                    <h5 class="modal-title text-white" style="font-size: 16px;">
                        <i class="bi bi-gear-fill me-2 spin-animation"></i>æŠ¥å‘Šç”Ÿæˆä¸­
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" style="margin-left: auto;"></button>
                </div>
                <div class="modal-body" style="padding: 10px; height: calc(100% - 40px); display: flex; flex-direction: column;">
                    <!-- Progress Steps -->
                    <div class="row mb-2">
                        <div class="col">
                            <div class="d-flex justify-content-between">
                                <div class="step-item text-center" id="step-1" style="flex: 1;">
                                    <div class="step-circle bg-secondary text-white" style="width: 30px; height: 30px; font-size: 14px;">1</div>
                                    <small class="d-block mt-1 text-muted" style="font-size: 10px;">è§£æè¯·æ±‚</small>
                                </div>
                                <div class="step-line" style="height: 1px; margin: 15px 2px;"></div>
                                <div class="step-item text-center" id="step-2" style="flex: 1;">
                                    <div class="step-circle bg-secondary text-white" style="width: 30px; height: 30px; font-size: 14px;">2</div>
                                    <small class="d-block mt-1 text-muted" style="font-size: 10px;">ç”Ÿæˆå¤§çº²</small>
                                </div>
                                <div class="step-line" style="height: 1px; margin: 15px 2px;"></div>
                                <div class="step-item text-center" id="step-3" style="flex: 1;">
                                    <div class="step-circle bg-secondary text-white" style="width: 30px; height: 30px; font-size: 14px;">3</div>
                                    <small class="d-block mt-1 text-muted" style="font-size: 10px;">ç”Ÿæˆå†…å®¹</small>
                                </div>
                                <div class="step-line" style="height: 1px; margin: 15px 2px;"></div>
                                <div class="step-item text-center" id="step-4" style="flex: 1;">
                                    <div class="step-circle bg-secondary text-white" style="width: 30px; height: 30px; font-size: 14px;">4</div>
                                    <small class="d-block mt-1 text-muted" style="font-size: 10px;">åˆ†ææ•°æ®</small>
                                </div>
                                <div class="step-line" style="height: 1px; margin: 15px 2px;"></div>
                                <div class="step-item text-center" id="step-5" style="flex: 1;">
                                    <div class="step-circle bg-secondary text-white" style="width: 30px; height: 30px; font-size: 14px;">5</div>
                                    <small class="d-block mt-1 text-muted" style="font-size: 10px;">å®Œæˆ</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Timer and Controls -->
                    <div class="d-flex justify-content-between align-items-center bg-light p-2 rounded mb-2">
                        <div>
                            <span class="text-muted" style="font-size: 12px;">ç”¨æ—¶ï¼š<span id="elapsed-seconds-modal" class="text-danger fw-bold">0</span> ç§’</span>
                        </div>
                        <div>
                            <button type="button" class="btn btn-sm btn-outline-primary me-1" id="backgroundRunBtn" style="padding: 2px 6px; font-size: 12px;">åå°è¿è¡Œ</button>
                            <button type="button" class="btn btn-sm btn-outline-danger me-1" id="stopBtn" style="padding: 2px 6px; font-size: 12px;">åœæ­¢</button>
                            <button type="button" class="btn btn-sm btn-secondary" id="closeProgressBtn" disabled style="padding: 2px 6px; font-size: 12px;">å…³é—­</button>
                        </div>
                    </div>
                    
                    <!-- LLM Live Output -->
                    <div class="card mb-2" style="height: 45vh; min-height: 300px;">
                        <div class="card-header py-1" style="font-size: 12px; padding: 4px 8px;"><i class="bi bi-lightning-charge-fill text-warning"></i> LLM å®æ—¶å†…å®¹</div>
                        <div class="card-body p-1" style="overflow-y: auto; height: calc(100% - 25px);">
                            <pre id="llmOutput" class="m-0" style="font-family: 'Courier New', monospace; white-space: pre-wrap; word-wrap: break-word; font-size:11px;">ç­‰å¾…å¼€å§‹...</pre>
                        </div>
                    </div>

                    <!-- Status Message -->
                    <div class="alert alert-info mb-0 p-2" id="statusMessage" style="font-size: 12px; padding: 4px 8px; height: 20vh; overflow-y: auto;">
                        <i class="bi bi-info-circle me-1"></i>AIæ­£åœ¨ç”ŸæˆæŠ¥å‘Š...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .step-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            transition: all 0.3s;
        }
        .step-line {
            flex: 1;
            height: 2px;
            background: #dee2e6;
            margin: 0 10px;
            align-self: center;
        }
        .step-item.active .step-circle {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%) !important;
            transform: scale(1.1);
        }
        .step-item.completed .step-circle {
            background: #28a745 !important;
        }
        .spin-animation {
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/floating_task.js') }}"></script>
    <script>
        
        let progressModal;
        let currentStep = 1;
        let reportId = null;
        let timerStart = null;
        let timerHandle = null;
        let lastLogLine = '';
        let currentTaskId = null;
        let currentCity = '';
        let currentIndustry = '';
        
        document.getElementById('generateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const city = document.getElementById('city').value.trim();
            const industry = document.getElementById('industry').value.trim();
            const llmService = document.getElementById('llm_service').value;
            const useStreaming = document.getElementById('use_streaming').checked;
            const additional = document.getElementById('additional_context').value;
            
            // Store for background run button
            currentCity = city;
            currentIndustry = industry;
            
            if (!city || !industry) {
                alert('è¯·å¡«å†™åŸå¸‚å’Œè¡Œä¸šåç§°');
                return false;
            }
            
            // Show progress modal for all generation types
            progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
            progressModal.show();

            // Allow user to close anytime
            const closeBtn = document.getElementById('closeProgressBtn');
            closeBtn.disabled = false;
            closeBtn.textContent = 'å…³é—­';
            closeBtn.onclick = () => {
                try { progressModal.hide(); } catch (e) {}
                window.location.href = '/';
            };
            
            // Handle stop button
            const stopBtn = document.getElementById('stopBtn');
            stopBtn.onclick = async () => {
                if (confirm('ç¡®å®šè¦åœæ­¢æŠ¥å‘Šç”Ÿæˆå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                    // Stop the task if taskId exists
                    if (window.backgroundTasks && window.backgroundTasks.length > 0) {
                        const currentTask = window.backgroundTasks[window.backgroundTasks.length - 1];
                        if (currentTask.taskId) {
                            try {
                                // Call API to stop the task
                                await fetch(`/api/stop-task/${currentTask.taskId}`, {
                                    method: 'POST'
                                });
                            } catch (e) {
                                console.error('Error stopping task:', e);
                            }
                        }
                    }
                    
                    // Clear intervals
                    if (timerHandle) clearInterval(timerHandle);
                    
                    // Hide modal and go back
                    try { progressModal.hide(); } catch (e) {}
                    window.history.back();
                }
            };
            
            // Handle background run
            const backgroundBtn = document.getElementById('backgroundRunBtn');
            backgroundBtn.onclick = () => {
                // Add task to floating task manager if task was created
                if (currentTaskId && typeof window.addBackgroundTask === 'function') {
                    window.addBackgroundTask(currentTaskId, currentCity, currentIndustry);
                }
                
                // Clear intervals
                if (timerHandle) clearInterval(timerHandle);
                
                // Hide modal immediately
                try { 
                    if (progressModal) {
                        progressModal.hide(); 
                    }
                } catch (e) {
                    console.error('Error hiding modal:', e);
                }
                
                // Redirect to homepage immediately
                window.location.href = '/';
            };
            
            // Original polling function (will be triggered after task creation)
            const pollTaskStatus = (taskId) => {
                    const maxAttempts = 180;
                    let attempt = 0;
                    let stopRequested = false;
                    
                    // Listen for stop request
                    const stopBtn = document.getElementById('stopBtn');
                    if (stopBtn) {
                        stopBtn.onclick = async () => {
                            if (confirm('ç¡®å®šè¦åœæ­¢æŠ¥å‘Šç”Ÿæˆå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                                stopRequested = true;
                                
                                // Stop the task if taskId exists
                                try {
                                    await fetch(`/api/stop-task/${taskId}`, {
                                        method: 'POST'
                                    });
                                } catch (e) {
                                    console.error('Error stopping task:', e);
                                }
                                
                                // Clear intervals
                                clearInterval(interval);
                                if (timerHandle) clearInterval(timerHandle);
                                
                                // Update UI
                                document.getElementById('statusMessage').className = 'alert alert-warning mb-0';
                                document.getElementById('statusMessage').innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>æŠ¥å‘Šç”Ÿæˆå·²åœæ­¢';
                                document.getElementById('closeProgressBtn').disabled = false;
                                document.getElementById('closeProgressBtn').textContent = 'è¿”å›';
                                document.getElementById('closeProgressBtn').onclick = () => {
                                    window.history.back();
                                };
                            }
                        };
                    }
                    const interval = setInterval(async () => {
                        // Check if stop was requested
                        if (stopRequested) {
                            clearInterval(interval);
                            return;
                        }
                        
                        attempt++;
                        if (attempt > maxAttempts) {
                            clearInterval(interval);
                            try {
                                if (window.opener && window.opener.updateFloatingIconStatus) {
                                    window.opener.updateFloatingIconStatus(false); // Still processing
                                } else {
                                    // If window.opener is not available, update icon in current window
                                    if (typeof updateFloatingIconStatus !== 'undefined') {
                                        updateFloatingIconStatus(false); // Still processing
                                    }
                                }
                            } catch (e) {
                                // If there's an error accessing window.opener, try to update icon in current window
                                try {
                                    if (typeof updateFloatingIconStatus !== 'undefined') {
                                        updateFloatingIconStatus(false); // Still processing
                                    }
                                } catch (e2) {
                                    // Ignore errors when updating status
                                }
                            }
                            return;
                        }
                        
                        try {
                            const response = await fetch(`/api/task-status/${taskId}`);
                            const data = await response.json();
                            
                            const state = (data.state || '').toUpperCase();
                            const status = (data.status || '').toLowerCase();
                            const result = data.result || {};
                            
                            // Handle success
                            if (state === 'SUCCESS' || status === 'completed') {
                                clearInterval(interval);
                                // Update floating icon to red/completed state
                                try {
                                    if (window.opener && window.opener.updateFloatingIconStatus) {
                                        const reportId = result.report_id || data.report_id;
                                        window.opener.updateFloatingIconStatus(true, reportId); // Red/completed state
                                    } else {
                                        // If window.opener is not available, update icon in current window
                                        if (typeof updateFloatingIconStatus !== 'undefined') {
                                            const reportId = result.report_id || data.report_id;
                                            updateFloatingIconStatus(true, reportId); // Red/completed state
                                        }
                                    }
                                } catch (e) {
                                    // If there's an error accessing window.opener, try to update icon in current window
                                    try {
                                        if (typeof updateFloatingIconStatus !== 'undefined') {
                                            const reportId = result.report_id || data.report_id;
                                            updateFloatingIconStatus(true, reportId); // Red/completed state
                                        }
                                    } catch (e2) {
                                        console.error('Error updating floating icon status:', e, e2);
                                    }
                                }
                                return;
                            }
                            
                            // Handle failure
                            if (state === 'FAILURE' || state === 'REVOKED' || status === 'failed') {
                                clearInterval(interval);
                                // Keep icon in yellow state to indicate error
                                try {
                                    if (window.opener && window.opener.updateFloatingIconStatus) {
                                        window.opener.updateFloatingIconStatus(false);
                                    } else {
                                        // If window.opener is not available, update icon in current window
                                        if (typeof updateFloatingIconStatus !== 'undefined') {
                                            updateFloatingIconStatus(false);
                                        }
                                    }
                                } catch (e) {
                                    // If there's an error accessing window.opener, try to update icon in current window
                                    try {
                                        if (typeof updateFloatingIconStatus !== 'undefined') {
                                            updateFloatingIconStatus(false);
                                        }
                                    } catch (e2) {
                                        // Ignore errors when updating status
                                    }
                                }
                                return;
                            }
                        } catch (error) {
                            console.error('Error polling task status:', error);
                        }
                    }, 2000);
                };
            
            // Reset state
            currentStep = 1;
            updateStep(1);
            const statusMsg = document.getElementById('statusMessage');
            if (statusMsg) {
                statusMsg.innerHTML = '<i class="bi bi-info-circle me-1"></i>å¼€å§‹ç”Ÿæˆ...';
            }

            // Start timer
            timerStart = Date.now();
            const elapsedEl = document.getElementById('elapsed-seconds-modal');
            if (timerHandle) clearInterval(timerHandle);
            timerHandle = setInterval(() => {
                const secs = Math.floor((Date.now() - timerStart) / 1000);
                if (elapsedEl) elapsedEl.textContent = String(secs);
            }, 1000);
            
            if (useStreaming) {
                // Stream-based generation
                await startStreamingGeneration(city, industry, llmService, additional);
            } else {
                // Regular generation
                await startRegularGeneration(city, industry, llmService, additional);
            }
        });
        
        function updateStep(step) {
            // Mark previous steps as completed
            for (let i = 1; i < step; i++) {
                document.getElementById(`step-${i}`).classList.add('completed');
                document.getElementById(`step-${i}`).classList.remove('active');
            }
            // Mark current step as active
            document.getElementById(`step-${step}`).classList.add('active');
            currentStep = step;
        }
        
        function appendStreamContent(text) {
            const contentDiv = document.getElementById('statusMessage');
            if (!contentDiv) return;
            const trimmed = (text || '').trim();
            if (trimmed && trimmed === lastLogLine) return; // de-dup consecutive
            lastLogLine = trimmed || lastLogLine;
            contentDiv.innerHTML += text;
            contentDiv.scrollTop = contentDiv.scrollHeight;
        }
        
        async function startStreamingGeneration(city, industry, llmService, additional) {
            try {
                updateStep(1);
                appendStreamContent('\n<span class="text-success">âœ“</span> è§£æè¯·æ±‚å®Œæˆ\n');
                
                updateStep(2);
                appendStreamContent('<span class="text-success">âœ“</span> æ­£åœ¨è¿æ¥' + llmService.toUpperCase() + ' API...\n');
                
                // Start task in background
                const response = await fetch('/api/generate-report', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        city: city,
                        industry: industry,
                        llm_service: llmService,
                        additional_context: additional
                    })
                });
                
                const result = await response.json();
                if (result.task_id) {
                    // Store task ID for background run button
                    currentTaskId = result.task_id;
                    
                    // Store task ID in background tasks
                    if (window.backgroundTasks && window.backgroundTasks.length > taskIndex) {
                        window.backgroundTasks[taskIndex].taskId = result.task_id;
                    } else if (window.backgroundTasks && window.backgroundTasks.length > 0) {
                        // Fallback to last task if index is out of bounds
                        window.backgroundTasks[window.backgroundTasks.length - 1].taskId = result.task_id;
                    }
                    
                    updateStep(3);
                    appendStreamContent('<span class="text-success">âœ“</span> ä»»åŠ¡åˆ›å»ºæˆåŠŸ: ' + result.task_id + '\n');

                    // CRITICAL: Start true LLM streaming (SSE) - this provides real-time generation
                    appendStreamContent('<span class="text-info">â„¹</span> å¯åŠ¨æµå¼LLMç”Ÿæˆ...\n');
                    startLLMStream(city, industry, llmService, additional);
                    
                    // Poll for task completion status
                    await pollTaskStatus(result.task_id);
                } else {
                    throw new Error(result.error || 'ç”Ÿæˆå¤±è´¥');
                }
            } catch (error) {
                console.error(error);
                document.getElementById('statusMessage').className = 'alert alert-danger mb-0';
                document.getElementById('statusMessage').innerHTML = '<i class="bi bi-x-circle me-2"></i>ç”Ÿæˆå¤±è´¥: ' + error.message;
                document.getElementById('closeProgressBtn').disabled = false;
            }
        }
        
        async function pollTaskStatus(taskId) {
            const maxAttempts = 180; // up to ~6 minutes
            let attempt = 0;

            const stageToStep = (stage) => {
                const map = { init: 1, outline: 2, generation: 3, analysis: 4, finalize: 5 };
                return map[(stage || '').toLowerCase()] || null;
            };
            
            const interval = setInterval(async () => {
                attempt++;
                if (attempt > maxAttempts) {
                    clearInterval(interval);
                    document.getElementById('statusMessage').className = 'alert alert-warning mb-0';
                    document.getElementById('statusMessage').innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>ç”Ÿæˆè¶…æ—¶ï¼Œè¯·ç¨ååœ¨â€œæˆ‘çš„æŠ¥å‘Šâ€ä¸­æŸ¥çœ‹ã€‚';
                    document.getElementById('closeProgressBtn').disabled = false;
                    return;
                }
                
                try {
                    const response = await fetch(`/api/task-status/${taskId}`);
                    const data = await response.json();

                    const state = (data.state || '').toUpperCase();
                    const status = (data.status || '').toLowerCase();
                    const result = data.result || {};

                    // Handle success
                    if (state === 'SUCCESS' || status === 'completed') {
                        clearInterval(interval);
                        updateStep(4);
                        appendStreamContent('\n<span class="text-success">âœ“</span> å†…å®¹ç”Ÿæˆå®Œæˆ');
                        updateStep(5);
                        appendStreamContent('\n<span class="text-success">âœ“</span> æŠ¥å‘Šç”ŸæˆæˆåŠŸ!\n');

                        reportId = result.report_id || data.report_id || reportId;
                        document.getElementById('statusMessage').className = 'alert alert-success mb-0';
                        document.getElementById('statusMessage').innerHTML = '<i class="bi bi-check-circle me-2"></i>æŠ¥å‘Šç”ŸæˆæˆåŠŸï¼å³å°†è·³è½¬...';
                        document.getElementById('closeProgressBtn').disabled = false;
                        document.getElementById('closeProgressBtn').textContent = 'æŸ¥çœ‹æŠ¥å‘Š';
                        document.getElementById('closeProgressBtn').onclick = () => {
                            window.location.href = '/report/' + reportId;
                        };
                        
                        // Update floating icon to red/completed state
                        try {
                            if (window.opener && window.opener.updateFloatingIconStatus) {
                                window.opener.updateFloatingIconStatus(true, reportId); // Red/completed state
                            }
                        } catch (e) {
                            console.error('Error updating floating icon status:', e);
                        }
                        
                        // auto redirect after short delay
                        if (timerHandle) clearInterval(timerHandle);
                        if (reportId) {
                            setTimeout(() => window.location.href = '/report/' + reportId, 1200);
                        }
                        return;
                    }

                    // Handle failure
                    if (state === 'FAILURE' || state === 'REVOKED' || status === 'failed') {
                        clearInterval(interval);
                        throw new Error((data.error_details && data.error_details.error_message) || data.status || 'ç”Ÿæˆå¤±è´¥');
                    }

                    // Handle progress
                    if (state === 'PROGRESS' || state === 'PENDING' || status === 'waiting' || status === 'progress') {
                        const stage = (data.stage || (data.message && data.message.stage) || '').toString();
                        const step = stageToStep(stage);
                        if (step) updateStep(step);
                        const msg = data.message || data.status || `å¤„ç†ä¸­(${attempt})...`;
                        appendStreamContent(`\n[${stage || 'progress'}] ${msg}`);
                    }
                } catch (error) {
                    clearInterval(interval);
                    console.error(error);
                    if (timerHandle) clearInterval(timerHandle);
                    document.getElementById('statusMessage').className = 'alert alert-danger mb-0';
                    document.getElementById('statusMessage').innerHTML = '<i class="bi bi-x-circle me-2"></i>é”™è¯¯: ' + (error.message || error);
                    const closeBtn = document.getElementById('closeProgressBtn');
                    closeBtn.disabled = false;
                    closeBtn.textContent = 'å…³é—­';
                    closeBtn.onclick = () => { try { progressModal.hide(); } catch(e){} window.location.href = '/'; };
                }
            }, 2000);
        }

        // Start SSE to stream LLM content
        async function startLLMStream(city, industry, llmService, additional) {
            try {
                console.log('[LLM Stream] Starting SSE connection...', { city, industry, llmService });
                appendStreamContent('\n<span class="text-primary">â–¶</span> [LLM] å¼€å§‹æµå¼ç”Ÿæˆ...\n');
                
                const response = await fetch('/streaming/api/stream/generate-report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        city, 
                        industry, 
                        llm_service: llmService,
                        additional_context: additional || ''
                    })
                });
                
                console.log('[LLM Stream] Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[LLM Stream] Connection failed:', response.status, errorText);
                    appendStreamContent('\n<span class="text-danger">âœ—</span> [LLM] è¿æ¥å¤±è´¥: ' + response.status + ' - ' + errorText + '\n');
                    return;
                }
                
                if (!response.body) {
                    console.error('[LLM Stream] No response body');
                    appendStreamContent('\n<span class="text-danger">âœ—</span> [LLM] æ— å“åº”ä½“\n');
                    return;
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                const llmOutput = document.getElementById('llmOutput');
                let chunkCount = 0;
                
                console.log('[LLM Stream] Starting to read chunks...');
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) {
                        console.log('[LLM Stream] Stream ended, total chunks:', chunkCount);
                        appendStreamContent('\n<span class="text-success">âœ“</span> [LLM] æµå¼ç”Ÿæˆç»“æŸ\n');
                        break;
                    }
                    
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const evt = JSON.parse(line.slice(6));
                                chunkCount++;
                                
                                if (evt.type === 'report_chunk' && evt.data) {
                                    if (evt.data.accumulated) {
                                        llmOutput.textContent = evt.data.accumulated;
                                        // Auto-scroll
                                        llmOutput.scrollTop = llmOutput.scrollHeight;
                                    }
                                    if (evt.data.msg) {
                                        appendStreamContent('\n[LLM] ' + evt.data.msg);
                                    }
                                } else if (evt.type === 'generation_start') {
                                    console.log('[LLM Stream] Generation started');
                                    appendStreamContent('\n<span class="text-info">â„¹</span> [LLM] AIå¼€å§‹ç”Ÿæˆå†…å®¹...\n');
                                } else if (evt.type === 'report_complete') {
                                    console.log('[LLM Stream] Generation complete');
                                    appendStreamContent('\n<span class="text-success">âœ“</span> [LLM] AIç”Ÿæˆå®Œæˆ\n');
                                } else if (evt.type === 'error') {
                                    console.error('[LLM Stream] Error event:', evt.data);
                                    const errorMsg = (evt.data && (evt.data.error || evt.data.raw)) || 'Unknown error';
                                    appendStreamContent('\n<span class="text-danger">âœ—</span> [LLM] é”™è¯¯: ' + errorMsg + '\n');
                                }
                            } catch (e) {
                                console.warn('[LLM Stream] Failed to parse event:', line, e);
                            }
                        }
                    }
                }
            } catch (e) {
                console.error('[LLM Stream] Exception:', e);
                appendStreamContent('\n<span class="text-danger">âœ—</span> [LLM] è¿æ¥å¼‚å¸¸: ' + e.message + '\n');
            }
        }
        
        async function startRegularGeneration(city, industry, llmService, additional) {
            // Similar to streaming but without real-time updates
            await startStreamingGeneration(city, industry, llmService, additional);
        }
    </script>
</body>
</html>
