<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¿ç­–è§£è¯»åŠ©æ‰‹ - åŒºåŸŸäº§ä¸šåˆ†æå°å·¥ä½œå°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- jsMind Library for Mindmap Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/jsmind@0.7.0/js/jsmind.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsmind@0.7.0/style/jsmind.css" />
    <!-- Chart.js for Data Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .timeline {
            position: relative;
            padding: 20px 0;
        }

        .timeline-item {
            display: flex;
            margin-bottom: 15px;
            position: relative;
            padding-left: 30px;
        }

        .timeline-marker {
            position: absolute;
            left: 0;
            top: 5px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #0d6efd;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .timeline-content {
            flex: 1;
            padding-left: 15px;
            border-left: 2px solid #dee2e6;
            padding-bottom: 15px;
        }

        .radar-chart-container {
            position: relative;
        }

        .region-heatmap {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('index') }}">ğŸ“‹ æ”¿ç­–è§£è¯»åŠ©æ‰‹</a>
            <div class="ms-auto">
                <a href="{{ url_for('index') }}" class="btn btn-outline-light btn-sm">è¿”å›é¦–é¡µ</a>
                <a href="{{ url_for('wechat_config_page') }}" class="btn btn-outline-light btn-sm ms-2">é…ç½®ç®¡ç†</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2 class="mb-4"><i class="bi bi-file-earmark-ruled"></i> æ”¿ç­–è§£è¯»åŠ©æ‰‹</h2>

        <ul class="nav nav-tabs" id="policyTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="search-tab" data-bs-toggle="tab" data-bs-target="#searchPane" type="button" role="tab" aria-controls="searchPane" aria-selected="true">æ™ºèƒ½æ£€ç´¢</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="upload-tab" data-bs-toggle="tab" data-bs-target="#uploadPane" type="button" role="tab" aria-controls="uploadPane" aria-selected="false">ä¸Šä¼ è§£æ</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="wechat-tab" data-bs-toggle="tab" data-bs-target="#wechatPane" type="button" role="tab" aria-controls="wechatPane" aria-selected="false">å¾®ä¿¡å…¬ä¼—å·</button>
            </li>
        </ul>
        <div class="tab-content" id="policyTabsContent">
            <div class="tab-pane fade show active" id="searchPane" role="tabpanel" aria-labelledby="search-tab">
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">æ™ºèƒ½æ£€ç´¢ï¼ˆåŒºåŸŸÃ—äº§ä¸šÃ—æ—¶é—´ï¼‰</h5>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">åŒºåŸŸï¼ˆçœ/å¸‚/åŒºï¼‰</label>
                                <input type="text" class="form-control" id="regionInput" placeholder="å¦‚ï¼šå››å·çœ æˆéƒ½å¸‚ é«˜æ–°åŒº" value="å››å·çœ">
                                <small class="text-muted">é‡‡ç”¨GB/T 2260-2022ç¼–ç ï¼ˆåå°è‡ªåŠ¨åŒ¹é…ï¼‰</small>
                            </div>
                            <div class="col-md-5">
                                <label class="form-label">äº§ä¸šæ ‡ç­¾ï¼ˆå¤šçº§ï¼‰</label>
                                <input type="text" class="form-control" id="industryTagsInput" placeholder="å¦‚ï¼šäººå·¥æ™ºèƒ½,AIèŠ¯ç‰‡" value="äººå·¥æ™ºèƒ½">
                                <small class="text-muted">å‚è€ƒGB/T 4754-2017åˆ†ç±»ï¼Œæ”¯æŒå¤šæ ‡ç­¾</small>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">æ—¶é—´èŒƒå›´</label>
                                <select class="form-select" id="timeRange">
                                    <option value="3" selected>è¿‘3å¹´</option>
                                    <option value="1">è¿‘1å¹´</option>
                                    <option value="5">è¿‘5å¹´</option>
                                </select>
                            </div>
                        </div>
                        <div class="row g-3 mt-1">
                            <div class="col-md-6">
                                <label class="form-label">å…³é”®è¯</label>
                                <input type="text" class="form-control" id="searchKeyword" placeholder="å¦‚ï¼šèµ„é‡‘è¡¥è´´ã€ç¨æ”¶ä¼˜æƒ ">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">æ”¿ç­–åˆ†ç±»</label>
                                <select class="form-select" id="searchCategory">
                                    <option value="">å…¨éƒ¨</option>
                                    <option value="äº§ä¸šæ”¿ç­–">äº§ä¸šæ”¿ç­–</option>
                                    <option value="æ‰¶æŒæ”¿ç­–">æ‰¶æŒæ”¿ç­–</option>
                                    <option value="èµ„é‡‘æ”¯æŒ">èµ„é‡‘æ”¯æŒ</option>
                                    <option value="ç”³æŠ¥æŒ‡å—">ç”³æŠ¥æŒ‡å—</option>
                                    <option value="ç¨æ”¶ç›®å½•">ç¨æ”¶ç›®å½•</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-success" id="searchPoliciesBtn"><i class="bi bi-search"></i> å¼€å§‹æ£€ç´¢</button>
                        </div>
                    </div>
                </div>
                <div class="card mb-4" aria-live="polite" aria-busy="false">
                    <div class="card-body">
                        <h5 class="card-title">æœç´¢ç»“æœ</h5>
                        <div id="policySearchResults" class="list-group"></div>
                    </div>
                </div>
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">æ•°æ®æºä¸å¤–éƒ¨é“¾æ¥</h5>
                        <div class="row g-3 mb-2">
                            <div class="col-md-6">
                                <input type="text" id="linkSearchInput" class="form-control" placeholder="æœç´¢é“¾æ¥æˆ–æ•°æ®æº">
                            </div>
                            <div class="col-md-3">
                                <select id="linkTypeFilter" class="form-select">
                                    <option value="">å…¨éƒ¨ç±»å‹</option>
                                    <option value="æ”¿ç­–åŸæ–‡">æ”¿ç­–åŸæ–‡</option>
                                    <option value="ç”³æŠ¥å…¥å£">ç”³æŠ¥å…¥å£</option>
                                    <option value="è§£é‡Šè§£è¯»">è§£é‡Šè§£è¯»</option>
                                    <option value="éƒ¨é—¨é¡µé¢">éƒ¨é—¨é¡µé¢</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select id="linkImportanceFilter" class="form-select">
                                    <option value="">å…¨éƒ¨é‡è¦æ€§</option>
                                    <option value="high">é«˜</option>
                                    <option value="medium">ä¸­</option>
                                    <option value="low">ä½</option>
                                </select>
                            </div>
                        </div>
                        <div class="row g-3">
                            <div class="col-12 col-lg-6">
                                <h6 class="mb-2">æ•°æ®æº</h6>
                                <table class="table table-sm" id="dataSourcesTable">
                                    <thead><tr><th>æ¥æº</th><th>åç§°</th><th>æ›´æ–°æ—¶é—´</th><th>æ ¼å¼</th><th>çœŸå®æ€§</th><th>è´¨é‡</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            <div class="col-12 col-lg-6">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-2">å¤–éƒ¨é“¾æ¥</h6>
                                    <button class="btn btn-outline-secondary btn-sm" id="checkLinksBtn">æ£€æµ‹æœ‰æ•ˆæ€§</button>
                                </div>
                                <div id="linksList" class="list-group"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="uploadPane" role="tabpanel" aria-labelledby="upload-tab">
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">ä¸Šä¼ æ”¿ç­–æ–‡æ¡£</h5>
                        <p class="text-muted">æ”¯æŒPDFã€Wordã€TXTæ ¼å¼çš„æ”¿ç­–æ–‡ä»¶</p>
                        <form id="policyForm">
                            <div class="mb-3">
                                <label class="form-label">é€‰æ‹©æ–‡ä»¶</label>
                                <input type="file" class="form-control" id="policyFile" accept=".pdf,.doc,.docx,.txt,.md" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">AIæ¨¡å‹é€‰æ‹©</label>
                                <select class="form-select" id="llmSelect">
                                    <option value="kimi" selected>æœˆä¹‹æš—é¢ Kimi (é»˜è®¤)</option>
                                    <option value="ernie">ç™¾åº¦ ERNIE Bot</option>
                                    <option value="traditional">æœ¬åœ°NLPæ¨¡å‹ (spaCy)</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary"><i class="bi bi-play-circle"></i> å¼€å§‹è§£æ</button>
                        </form>

                        <div id="loadingPolicy" class="text-center" style="display: none;">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p>æ­£åœ¨è§£è¯»æ”¿ç­–æ–‡æ¡£ï¼Œè¯·ç¨å€™...</p>
                        </div>

                        <div id="policyResults" style="display: none;">
                            <div class="card mb-4">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="bi bi-file-text"></i> æ”¿ç­–å…ƒæ•°æ®</h5>
                                    <div id="policyMetadata"></div>
                                </div>
                            </div>

                            <div class="card mb-4">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="bi bi-star"></i> æ”¿ç­–è¦ç‚¹</h5>
                                    <div id="keyPoints"></div>
                                </div>
                            </div>

                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h5 class="card-title"><i class="bi bi-journal-bookmark"></i> æ”¿ç­–æ¡æ¬¾</h5>
                                            <div id="provisions"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h5 class="card-title"><i class="bi bi-check-circle"></i> ç”³è¯·è¦æ±‚</h5>
                                            <div id="requirements"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card mb-4">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="bi bi-bar-chart"></i> é‡åŒ–æ•°æ®</h5>
                                    <div id="quantitativeData"></div>
                                </div>
                            </div>

                            <div class="card mb-4">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="bi bi-calendar-event"></i> æ”¿ç­–æ—¶é—´è½´</h5>
                                    <div id="timeline"></div>
                                </div>
                            </div>

                            <!-- Advanced Analysis Section -->
                            <div class="card mb-4">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="bi bi-diagram-3"></i> é«˜çº§åˆ†æ</h5>
                                    <div id="industryRelevance"></div>
                                    <div id="policyStrength"></div>
                                    <div id="timelinessRegional"></div>
                                </div>
                            </div>

                            <div class="card mb-4">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="bi bi-graph-up"></i> é€‚ç”¨æ€§è¯„åˆ†</h5>
                                    <div class="text-center">
                                        <h1 class="display-4 text-primary" id="applicabilityScore">-</h1>
                                        <p class="text-muted">æ€»åˆ†100åˆ†</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Visualization Section will be added dynamically by JavaScript -->
                            <div id="dynamicVisualizations">
                                <h5>å†…å®¹å¯è§†åŒ–</h5>
                                <div id="visualizationArea" class="row"></div>
                            </div>

                            <!-- Mindmap Section -->
                            <div id="mindmapSection" class="card mb-4" style="display: none;">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="bi bi-diagram-3"></i> æ”¿ç­–æ€ç»´å¯¼å›¾</h5>
                                    <div id="mindmapContainer" style="width: 100%; height: 500px; border: 1px solid #ddd; overflow: auto;"></div>
                                    <div class="mt-3">
                                        <button class="btn btn-outline-primary btn-sm" id="expandAllMindmap">å±•å¼€å…¨éƒ¨</button>
                                        <button class="btn btn-outline-primary btn-sm" id="collapseAllMindmap">æŠ˜å å…¨éƒ¨</button>
                                        <button class="btn btn-outline-success btn-sm" id="exportMindmap">å¯¼å‡ºæ€ç»´å¯¼å›¾</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Visualization Section will be added dynamically by JavaScript -->

            </div>

            <div class="tab-pane fade" id="wechatPane" role="tabpanel" aria-labelledby="wechat-tab">
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-wechat"></i> å¾®ä¿¡å…¬ä¼—å·æ”¿ç­–è§£è¯»</h5>
                        <p class="text-muted">ä»å¾®ä¿¡å…¬ä¼—å·è·å–æœ€æ–°çš„æ”¿ç­–è§£è¯»æ–‡ç« </p>

                        <!-- WeChat Search Form -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <label class="form-label">åŒºåŸŸ</label>
                                <input type="text" class="form-control" id="wechatRegion" placeholder="å¦‚ï¼šå››å·çœã€æˆéƒ½å¸‚" value="å››å·çœ">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">äº§ä¸š</label>
                                <input type="text" class="form-control" id="wechatIndustry" placeholder="å¦‚ï¼šäººå·¥æ™ºèƒ½ã€æ–°èƒ½æº" value="äººå·¥æ™ºèƒ½">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">å…¬ä¼—å·åç§°</label>
                                <input type="text" class="form-control" id="wechatAccount" placeholder="å¦‚ï¼šå››å·æ”¿ç­–å‘å¸ƒ">
                            </div>
                        </div>

                        <div class="d-flex gap-2 mb-4">
                            <button class="btn btn-primary" id="fetchWechatArticlesBtn">
                                <i class="bi bi-search"></i> è·å–æ”¿ç­–æ–‡ç« 
                            </button>
                            <button class="btn btn-outline-success" id="searchWechatBtn">
                                <i class="bi bi-search"></i> æœç´¢æ–‡ç« 
                            </button>
                            <button class="btn btn-outline-info" id="fetchAccountArticlesBtn">
                                <i class="bi bi-journal"></i> è·å–å…¬ä¼—å·æ–‡ç« 
                            </button>
                        </div>

                        <!-- Loading indicator -->
                        <div id="wechatLoading" class="text-center" style="display: none;">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p>æ­£åœ¨è·å–å¾®ä¿¡å…¬ä¼—å·æ–‡ç« ï¼Œè¯·ç¨å€™...</p>
                        </div>

                        <!-- Search keywords input for searchWechatBtn -->
                        <div class="row g-3 mb-4 mt-3" id="wechatSearchKeywordsSection" style="display: none;">
                            <div class="col-md-12">
                                <label class="form-label">æœç´¢å…³é”®è¯ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰</label>
                                <input type="text" class="form-control" id="wechatSearchKeywords" placeholder="èµ„é‡‘è¡¥è´´,ç¨æ”¶ä¼˜æƒ ,äººæ‰å¼•è¿›">
                            </div>
                        </div>

                        <!-- WeChat articles results -->
                        <div id="wechatArticlesResults" class="row">
                            <!-- WeChat articles will be displayed here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-4">
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">ç»“æœå±•ç¤º</h5>
                <div id="resultContent" style="min-height:200px"></div>
            </div>
        </div>
    </div>

    <div class="offcanvas offcanvas-end" tabindex="-1" id="policyDetailPanel" aria-labelledby="policyDetailLabel">
        <div class="offcanvas-header">
            <h5 id="policyDetailLabel">æ”¿ç­–è¯¦æƒ…</h5>
            <div class="btn-group me-2" role="group" aria-label="å­—ä½“å¤§å°">
                <button class="btn btn-outline-secondary btn-sm" id="fontMinus" aria-label="å‡å°å­—ä½“">A-</button>
                <button class="btn btn-outline-secondary btn-sm" id="fontDefault" aria-label="é»˜è®¤å­—ä½“">A</button>
                <button class="btn btn-outline-secondary btn-sm" id="fontPlus" aria-label="å¢å¤§å­—ä½“">A+</button>
            </div>
            <button class="btn btn-outline-primary btn-sm" id="printBtn" aria-label="æ‰“å°">æ‰“å°</button>
            <button class="btn btn-outline-success btn-sm ms-2" id="downloadBtn" aria-label="ä¸‹è½½">ä¸‹è½½</button>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="å…³é—­"></button>
        </div>
        <div class="offcanvas-body">
            <div class="row g-3">
                <div class="col-12 col-lg-3">
                    <nav id="tocNav" class="list-group" aria-label="ç›®å½•"></nav>
                </div>
                <div class="col-12 col-lg-9">
                    <div id="detailLoading" class="text-center" style="display:none">
                        <div class="spinner-border text-primary" role="status" aria-live="assertive" aria-busy="true"></div>
                        <p>æ­£åœ¨åŠ è½½æ­£æ–‡...</p>
                    </div>
                    <div id="detailError" class="alert alert-warning d-none" role="alert">
                        æ­£æ–‡è·å–å¤±è´¥
                        <button class="btn btn-link p-0 ms-2" id="retryBtn">é‡è¯•</button>
                        <a href="mailto:support@example.com" class="btn btn-link p-0 ms-2">è”ç³»æ”¯æŒ</a>
                    </div>
                    <div id="detailContent" style="font-size:16px; line-height:1.6"></div>
                    <div class="d-flex justify-content-between align-items-center mt-3" id="paginationBar" style="display:none">
                        <button class="btn btn-outline-secondary btn-sm" id="prevPage" aria-label="ä¸Šä¸€é¡µ">ä¸Šä¸€é¡µ</button>
                        <span id="pageInfo" class="text-muted"></span>
                        <button class="btn btn-outline-secondary btn-sm" id="nextPage" aria-label="ä¸‹ä¸€é¡µ">ä¸‹ä¸€é¡µ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // æ™ºèƒ½æ£€ç´¢äº¤äº’
        let lastSearchPayload = null;
        let currentDetail = { meta: {}, pages: [], pageIndex: 0, downloadUrl: '' };
        document.getElementById('searchPoliciesBtn').addEventListener('click', async function() {
            const region = document.getElementById('regionInput').value.trim();
            const tagsStr = document.getElementById('industryTagsInput').value.trim();
            const years = parseInt(document.getElementById('timeRange').value, 10);
            if (!region || !tagsStr) { alert('è¯·è¾“å…¥åŒºåŸŸä¸äº§ä¸šæ ‡ç­¾'); return; }
            const industry_tags = tagsStr.split(',').map(s => s.trim()).filter(Boolean);
            const payload = { region, region_code: '${placeholder_region_code}', industry_tags, time_range_years: years };
            lastSearchPayload = payload;
            try {
                document.getElementById('loadingPolicy').style.display = 'block';
                document.getElementById('policyResults').style.display = 'none';
                const resp = await fetch('/api/policy/search', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const json = await resp.json();
                document.getElementById('loadingPolicy').style.display = 'none';
                if (!json.success) { alert(json.error || 'æ£€ç´¢å¤±è´¥'); return; }
                renderAggregatedPolicies(json.data);
                renderSearchResults(json.data.policies || []);
                await loadDataSources();
                await loadLinks();
            } catch (e) {
                document.getElementById('loadingPolicy').style.display = 'none';
                alert('æ£€ç´¢å¤±è´¥: ' + e.message);
            }
        });

        function renderAggregatedPolicies(data) {
            document.getElementById('policyResults').style.display = 'block';
            const policies = data.policies || [];
            const timeline = data.timeline || [];
            // æ¸²æŸ“è¦ç‚¹ï¼ˆå–æ”¿ç­–æ ‡é¢˜ï¼‰
            let keyHtml = '<div class="list-group">';
            policies.slice(0, 8).forEach((p, i) => {
                keyHtml += `<div class="list-group-item"><span class="badge bg-primary me-2">${i+1}</span>${p.title} <span class="badge bg-light text-dark ms-2">${p.timeliness||''}</span></div>`
            });
            keyHtml += '</div>';
            document.getElementById('keyPoints').innerHTML = keyHtml || '<p class="text-muted">æš‚æ— è¦ç‚¹</p>';
            // æ¸²æŸ“æ—¶é—´è½´
            let tHtml = '<div class="list-group">';
            timeline.forEach(ev => {
                tHtml += `<div class="list-group-item"><div class="d-flex w-100 justify-content-between"><h6 class="mb-1">${ev.date}</h6><small>${ev.type}</small></div><p class="mb-1">${ev.title}ï½œ${ev.source||''}</p></div>`
            });
            tHtml += '</div>';
            document.getElementById('timeline').innerHTML = tHtml || '<p class="text-muted">æš‚æ— æ—¶é—´è½´æ•°æ®</p>';
        }

        function showPolicyDetailInResultArea(policy) {
            // Show policy detail in the main result area instead of offcanvas
            let detailHtml = '<div class="policy-detail-container">';
            detailHtml += `<h4>${policy.title}</h4>`;
            detailHtml += '<div class="policy-meta mb-3">';
            detailHtml += `<p><strong>å‘å¸ƒæ—¥æœŸï¼š</strong> ${policy.publish_date || 'N/A'}</p>`;
            detailHtml += `<p><strong>å‘å¸ƒæœºæ„ï¼š</strong> ${policy.source || policy.issuing_authority || 'N/A'}</p>`;

            // Add source information for WeChat articles
            if (policy.source_account) {
                detailHtml += `<p><strong>æ¥æºå…¬ä¼—å·ï¼š</strong> ${policy.source_account}</p>`;
                if (policy.official_link) {
                    detailHtml += `<p><strong>åŸæ–‡é“¾æ¥ï¼š</strong> <a href="${policy.official_link}" target="_blank" rel="noopener noreferrer" data-safe-link="1">${policy.official_link}</a></p>`;
                }
            } else if (policy.url) {
                detailHtml += `<p><strong>åŸæ–‡é“¾æ¥ï¼š</strong> <a href="${policy.url}" target="_blank" rel="noopener noreferrer" data-safe-link="1">${policy.url}</a></p>`;
            }

            detailHtml += '</div>';

            // Add content if available
            if (policy.content_html) {
                detailHtml += '<div class="policy-content">';
                detailHtml += policy.content_html;
                detailHtml += '</div>';
            } else if (policy.summary) {
                detailHtml += '<div class="policy-summary">';
                detailHtml += `<p>${policy.summary}</p>`;
                detailHtml += '</div>';
            } else if (policy.content) {
                detailHtml += '<div class="policy-content">';
                detailHtml += `<p>${policy.content}</p>`;
                detailHtml += '</div>';
            }

            detailHtml += '</div>';

            document.getElementById('resultContent').innerHTML = detailHtml;
            bindSafeLinkClicks();
        }

        function showSafeLinkModal(url) {
            const modalHtml = `<div class="modal" tabindex="-1" id="safeModal"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">å¤–éƒ¨é“¾æ¥å®‰å…¨æç¤º</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="å…³é—­"></button></div><div class="modal-body"><p>å³å°†æ‰“å¼€å¤–éƒ¨é“¾æ¥ï¼š</p><p class="text-break">${url}</p><p class="small text-muted">è¯·ç¡®è®¤é“¾æ¥æ¥æºå¯ä¿¡ï¼Œæ³¨æ„ä¿¡æ¯å®‰å…¨ã€‚</p></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button><button type="button" class="btn btn-primary" id="confirmOpen">ç»§ç»­æ‰“å¼€</button></div></div></div></div>`;
            const wrapper = document.createElement('div');
            wrapper.innerHTML = modalHtml;
            document.body.appendChild(wrapper);
            const modal = new bootstrap.Modal(wrapper.querySelector('#safeModal'));
            modal.show();
            wrapper.querySelector('#confirmOpen').onclick = async () => {
                try {
                    await fetch('/api/links/click', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url })
                    });
                } catch {}
                window.open(url, '_blank', 'noopener');
                modal.hide();
                document.body.removeChild(wrapper);
            };
            wrapper.querySelector('.btn-close').onclick = () => { document.body.removeChild(wrapper); };
        }

        function renderSearchResults(policies) {
            const container = document.getElementById('policySearchResults');
            container.innerHTML = '';
            if (!policies || policies.length === 0) {
                container.innerHTML = '<p class="text-muted">æš‚æ— æœç´¢ç»“æœ</p>';
                return;
            }
            const kw = (document.getElementById('searchKeyword').value || '').trim();
            const cat = document.getElementById('searchCategory').value || '';
            const filtered = policies.filter(p => {
                const matchKw = kw ? ((p.title||'').includes(kw) || (p.summary||'').includes(kw)) : true;
                const matchCat = cat ? ((p.type||'') === cat) : true;
                return matchKw && matchCat;
            });
            filtered.forEach((p, idx) => {
                const item = document.createElement('div');
                item.className = 'list-group-item d-flex justify-content-between align-items-start';
                let metaHtml = `<div class="ms-2 me-auto"><div class="fw-bold">${p.title}</div>`;
                metaHtml += `<small class="text-muted">å‘å¸ƒæ—¥æœŸï¼š${p.publish_date||'-'}ï½œå‘å¸ƒæœºæ„ï¼š${p.source||'-'}`;

                // Add source for WeChat articles
                if (p.source_account) {
                    metaHtml += `ï½œæ¥æºï¼š${p.source_account}`;
                    if (p.official_link) {
                        metaHtml += ` (<a href="${p.official_link}" target="_blank" rel="noopener noreferrer" data-safe-link="1">åŸæ–‡é“¾æ¥</a>)`;
                    }
                } else if (p.url) {
                    metaHtml += ` (<a href="${p.url}" target="_blank" rel="noopener noreferrer" data-safe-link="1">åŸæ–‡é“¾æ¥</a>)`;
                }

                metaHtml += `</small></div>`;

                const actionHtml = `<button class="btn btn-outline-primary btn-sm" data-index="${idx}" aria-label="æŸ¥çœ‹è¯¦æƒ…">æŸ¥çœ‹è¯¦æƒ…</button>`;
                item.innerHTML = metaHtml + actionHtml;
                container.appendChild(item);
            });
            container.querySelectorAll('a[role="button"],button[aria-label="æŸ¥çœ‹è¯¦æƒ…"],a[data-safe-link]').forEach(el => {
                el.addEventListener('click', (e) => {
                    if (el.getAttribute('data-safe-link')) {
                        e.preventDefault();
                        const url = el.href;
                        showSafeLinkModal(url);
                        return;
                    }

                    const i = parseInt(el.getAttribute('data-index'), 10);
                    const policy = filtered[i];
                    showPolicyDetailInResultArea(policy); // Show in result area instead of offcanvas
                });
            });
        }

        async function openPolicyDetail(policy) {
            // Use the new function to show in result area instead of offcanvas
            showPolicyDetailInResultArea(policy);
        }

        async function loadPolicyContent(policy) {
            document.getElementById('detailError').classList.add('d-none');
            document.getElementById('detailLoading').style.display = 'block';
            document.getElementById('detailContent').innerHTML = '';
            document.getElementById('paginationBar').style.display = 'none';
            try {
                const resp = await fetch('/api/policy/content', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: policy.url, title: policy.title, source: policy.source, publish_date: policy.publish_date })
                });
                const data = await resp.json();
                document.getElementById('detailLoading').style.display = 'none';
                if (!data.success) { throw new Error(data.error || 'è·å–æ­£æ–‡å¤±è´¥'); }
                currentDetail.meta = data.meta || {};
                currentDetail.pages = Array.isArray(data.content_pages) ? data.content_pages : [data.content_html || ''];
                currentDetail.pageIndex = 0;
                currentDetail.downloadUrl = data.download_url || '';
                renderDetailPage(0);
                renderToc(data.headings || []);
                bindDetailControls();
                document.getElementById('resultContent').innerHTML = data.content_html || '';
                bindSafeLinkClicks();

                // Try to generate mindmap from content
                try {
                    setTimeout(() => {
                        if (typeof generateMindmapFromAnalysis === 'function') {
                            generateMindmapFromAnalysis(data.content_html || '');
                        }
                    }, 100);
                } catch (e) {
                    console.warn('Could not generate mindmap:', e.message);
                }
            } catch (e) {
                document.getElementById('detailLoading').style.display = 'none';
                const err = document.getElementById('detailError');
                err.classList.remove('d-none');
                document.getElementById('retryBtn').onclick = () => loadPolicyContent(policy);
            }
        }

        function renderToc(headings) {
            const nav = document.getElementById('tocNav');
            nav.innerHTML = '';
            if (!headings || headings.length === 0) {
                nav.innerHTML = '<span class="text-muted">æš‚æ— ç›®å½•</span>';
                return;
            }
            headings.forEach((h, i) => {
                const a = document.createElement('a');
                a.className = 'list-group-item list-group-item-action';
                a.href = '#';
                a.textContent = h.text;
                a.setAttribute('data-index', i);
                a.addEventListener('click', e => { e.preventDefault(); });
                nav.appendChild(a);
            });
        }

        function renderDetailPage(index) {
            currentDetail.pageIndex = Math.max(0, Math.min(index, currentDetail.pages.length - 1));
            document.getElementById('detailContent').innerHTML = currentDetail.pages[currentDetail.pageIndex] || '';
            const bar = document.getElementById('paginationBar');
            if (currentDetail.pages.length > 1) {
                bar.style.display = 'flex';
                document.getElementById('pageInfo').textContent = `${currentDetail.pageIndex + 1} / ${currentDetail.pages.length}`;
            } else {
                bar.style.display = 'none';
            }
        }

        function bindDetailControls() {
            document.getElementById('prevPage').onclick = () => renderDetailPage(currentDetail.pageIndex - 1);
            document.getElementById('nextPage').onclick = () => renderDetailPage(currentDetail.pageIndex + 1);
            let size = 16;
            document.getElementById('fontMinus').onclick = () => { size = Math.max(12, size - 1); document.getElementById('detailContent').style.fontSize = size + 'px'; };
            document.getElementById('fontDefault').onclick = () => { size = 16; document.getElementById('detailContent').style.fontSize = size + 'px'; };
            document.getElementById('fontPlus').onclick = () => { size = Math.min(24, size + 1); document.getElementById('detailContent').style.fontSize = size + 'px'; };
            document.getElementById('printBtn').onclick = () => {
                const w = window.open('', '_blank');
                w.document.write('<!doctype html><html><head><meta charset="utf-8"><title>æ‰“å°</title></head><body>' + document.getElementById('detailContent').innerHTML + '</body></html>');
                w.document.close();
                w.focus();
                w.print();
                w.close();
            };
            document.getElementById('downloadBtn').onclick = () => {
                if (currentDetail.downloadUrl) { window.location.href = currentDetail.downloadUrl; return; }
                const blob = new Blob([document.getElementById('detailContent').innerHTML], { type: 'text/html;charset=utf-8' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = (currentDetail.meta.title || 'æ”¿ç­–å†…å®¹') + '.html';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            };
        }

        document.getElementById('policyForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const fileInput = document.getElementById('policyFile');

            if (!fileInput.files[0]) {
                alert('è¯·é€‰æ‹©æ–‡ä»¶');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            const selectedLLM = document.getElementById('llmSelect').value;
            formData.append('llm_service', selectedLLM);

            document.getElementById('loadingPolicy').style.display = 'block';
            document.getElementById('policyResults').style.display = 'none';
            document.getElementById('mindmapSection').style.display = 'none'; // Hide mindmap section initially

            try {
                const response = await fetch('/api/policy-analysis', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                document.getElementById('loadingPolicy').style.display = 'none';
                document.getElementById('policyResults').style.display = 'block';

                // Render policy metadata with summary
                renderPolicyMetadata(data.policy_metadata, data.summary || data.key_points?.[0] || '');

                // Render key points
                renderKeyPoints(data.key_points);

                // Render provisions
                renderProvisions(data.provisions);

                // Render requirements
                renderRequirements(data.requirements);

                // Render quantitative data
                renderQuantitativeData(data.quantitative_data);

                // Render timeline
                renderTimeline(data.timeline);

                // Render advanced analysis
                renderAdvancedAnalysis(data.analysis);

                // Render visualization data
                renderVisualizations(data.visualization_data);

                // Update applicability score
                const applicabilityScoreElement = document.getElementById('applicabilityScore');
                if (applicabilityScoreElement) {
                    applicabilityScoreElement.textContent = data.applicability_score || '-';
                }

                // Update full text display
                document.getElementById('resultContent').innerHTML = (data.full_text || '').replaceAll('\n','<br/>');

                bindSafeLinkClicks();

                // Generate and render mindmap after the main analysis
                // Using setTimeout to allow main content to load first
                setTimeout(() => {
                    // Wait a bit more to ensure jsMind is loaded, and check if it's available
                    const checkAndGenerateMindmap = () => {
                        if (typeof jsMind !== 'undefined') {
                            try {
                                // Attempt to generate mindmap from the analysis result
                                generateMindmapFromAnalysis(data);
                            } catch (error) {
                                console.error('Mindmap generation failed:', error);
                                document.getElementById('mindmapSection').style.display = 'none';
                            }
                        } else {
                            // jsMind might still be loading, try again after a short delay
                            setTimeout(() => {
                                if (typeof jsMind !== 'undefined') {
                                    try {
                                        generateMindmapFromAnalysis(data);
                                    } catch (error) {
                                        console.error('Mindmap generation failed:', error);
                                        document.getElementById('mindmapSection').style.display = 'none';
                                    }
                                } else {
                                    console.warn('jsMind library not available, skipping mindmap generation');
                                    document.getElementById('mindmapSection').style.display = 'none';
                                }
                            }, 500);
                        }
                    };

                    // Call immediately and if not ready, try again
                    checkAndGenerateMindmap();
                }, 1000);

            } catch (error) {
                console.error('Policy analysis error:', error);
                alert('æ”¿ç­–è§£è¯»å¤±è´¥: ' + error.message);
                document.getElementById('loadingPolicy').style.display = 'none';
            }
        });


        function renderSemanticAnalysis(analysis) {
            if (!analysis) {
                document.getElementById('semanticAnalysis').innerHTML = '<p class="text-muted">è¯­ä¹‰åˆ†æç»“æœåŠ è½½ä¸­...</p>';
                return;
            }

            // If it's the new format with detailed semantic analysis
            if (analysis.semantic_content) {
                let html = '<div class="list-group">';
                analysis.semantic_content.forEach((section, index) => {
                    html += `<div class="list-group-item">
                        <h6 class="mb-1">${section.title || 'åˆ†ææ®µè½ ' + (index + 1)}</h6>
                        <p class="mb-1">${section.summary || section.content || ''}</p>
                        <span class="badge bg-secondary">${section.category || 'æœªåˆ†ç±»'}</span>
                    </div>`;
                });
                html += '</div>';
                document.getElementById('semanticAnalysis').innerHTML = html;
            } else {
                // Fallback to the original analysis format
                let html = '<div class="list-group">';
                if (analysis.industry_relevance) {
                    html += `<div class="list-group-item">
                        <h6 class="mb-1">äº§ä¸šé“¾åˆ†æ</h6>
                        <p class="mb-1">ä¸Šæ¸¸: ${(analysis.industry_relevance.value_chain?.upstream || []).join(', ') || 'æ— '}</p>
                        <p class="mb-1">ä¸­æ¸¸: ${(analysis.industry_relevance.value_chain?.midstream || []).join(', ') || 'æ— '}</p>
                        <p class="mb-1">ä¸‹æ¸¸: ${(analysis.industry_relevance.value_chain?.downstream || []).join(', ') || 'æ— '}</p>
                    </div>`;
                }
                if (analysis.policy_strength) {
                    html += `<div class="list-group-item">
                        <h6 class="mb-1">æ”¿ç­–åŠ›åº¦è¯„ä¼°</h6>
                        <p class="mb-1">èµ„é‡‘ç­‰çº§: ${analysis.policy_strength.funding_level || 'æœªè¯„ä¼°'}</p>
                        <p class="mb-1">æªæ–½å¤šæ ·æ€§: ${analysis.policy_strength.measure_diversity || 0} é¡¹</p>
                    </div>`;
                }
                html += '</div>';
                document.getElementById('semanticAnalysis').innerHTML = html || '<p class="text-muted">æš‚æ— è¯­ä¹‰åˆ†æç»“æœ</p>';
            }
        }

        function renderContentClassification(classification) {
            if (!classification || classification.length === 0) {
                document.getElementById('contentClassification').innerHTML = '<p class="text-muted">å†…å®¹åˆ†ç±»å½’çº³åŠ è½½ä¸­...</p>';
                return;
            }

            let html = '<div class="row">';
            if (Array.isArray(classification)) {
                // If it's an array of key points
                classification.slice(0, 6).forEach((point, index) => {
                    html += `<div class="col-md-6 mb-2">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">è¦ç‚¹ ${index + 1}</h6>
                                <p class="card-text">${point || 'å†…å®¹åŠ è½½ä¸­...'}</p>
                            </div>
                        </div>
                    </div>`;
                });
            } else if (typeof classification === 'object') {
                // If it's a structured classification object
                for (const category in classification) {
                    const items = Array.isArray(classification[category]) ? classification[category] : [classification[category]];
                    html += `<div class="col-md-6 mb-2">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">${category}</h6>`;
                    items.slice(0, 3).forEach(item => {
                        html += `<p class="card-text">${item || 'å†…å®¹åŠ è½½ä¸­...'}</p>`;
                    });
                    html += '</div></div></div>';
                }
            }
            html += '</div>';
            document.getElementById('contentClassification').innerHTML = html;
        }

        function renderVisualizations(visualData) {
            if (!visualData) {
                document.getElementById('visualizationArea').innerHTML = '<div class="alert alert-info">æ­£åœ¨ç”Ÿæˆå†…å®¹å¯è§†åŒ–å›¾è¡¨...</div>';
                return;
            }

            let html = '';

            // Policy timeline visualization - Enhanced visualization
            const timelineData = visualData.timeline_chart || {};
            if (timelineData.dates && timelineData.dates.length > 0 && timelineData.events) {
                html += `
                <div class="col-md-12">
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6 class="card-title">æ”¿ç­–æ—¶é—´è½´</h6>
                            <div class="timeline-container" style="max-height: 300px; overflow-y: auto;">
                                <div class="timeline">
                `;
                for (let i = 0; i < timelineData.dates.length; i++) {
                    const date = timelineData.dates[i] || 'å¾…å®š';
                    const event = timelineData.events[i] || 'äº‹ä»¶';
                    html += `
                    <div class="timeline-item">
                        <div class="timeline-marker">
                            <i class="bi bi-calendar-event"></i>
                        </div>
                        <div class="timeline-content">
                            <h6 class="mb-1">${date}</h6>
                            <p class="mb-0">${event}</p>
                        </div>
                    </div>
                    `;
                }
                html += `
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            }

            // Industry network visualization - Enhanced visualization
            const networkData = visualData.industry_network || {};
            if (networkData.nodes && networkData.nodes.length > 0) {
                html += `
                <div class="col-md-6">
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6 class="card-title">äº§ä¸šé“¾å…³è”å›¾</h6>
                            <div class="industry-network">
                                <ul class="list-group">
                `;
                for (let i = 0; i < Math.min(networkData.nodes.length, 5); i++) {
                    const node = networkData.nodes[i];
                    html += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>${node.name}</span>
                        <span class="badge bg-primary rounded-pill">${node.category || 'ç±»åˆ«'}</span>
                    </li>
                    `;
                }
                html += `
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>`;
            }

            // Coverage heatmap - Enhanced visualization
            const heatmapData = visualData.heatmap_data || {};
            if (heatmapData.regions && heatmapData.regions.length > 0) {
                html += `
                <div class="col-md-6">
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6 class="card-title">åŒºåŸŸè¦†ç›–çƒ­åŠ›å›¾</h6>
                            <div class="region-heatmap">
                `;
                for (let i = 0; i < heatmapData.regions.length; i++) {
                    const region = heatmapData.regions[i];
                    const intensity = heatmapData.intensity && heatmapData.intensity[i] ? heatmapData.intensity[i] : 50;
                    const intensityClass = intensity > 75 ? 'bg-success' : intensity > 50 ? 'bg-warning' : 'bg-info';
                    html += `
                    <span class="badge ${intensityClass}" style="margin: 2px; padding: 6px 10px; display: inline-block; min-width: 80px;">
                        ${region} <span class="badge bg-light text-dark">${intensity}%</span>
                    </span>
                    `;
                }
                html += `
                            </div>
                        </div>
                    </div>
                </div>`;
            }

            // Radar chart visualization - Enhanced visualization
            const radarData = visualData.radar_chart || {};
            if (radarData.dimensions && radarData.dimensions.length > 0 && radarData.values) {
                html += `
                <div class="col-md-12">
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6 class="card-title">æ”¿ç­–æ”¯æŒåŠ›åº¦é›·è¾¾å›¾</h6>
                            <div class="radar-chart-container" style="height: 300px;">
                                <canvas id="policyRadarChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>`;

                // Add chart rendering after HTML is inserted
                setTimeout(() => {
                    renderRadarChart(radarData.dimensions, radarData.values);
                }, 100);
            }

            // If no visualizations are available, show a message
            if (!html) {
                html = '<div class="col-12"><div class="alert alert-info">æš‚æ— å¯è§†åŒ–æ•°æ®</div></div>';
            }

            document.getElementById('visualizationArea').innerHTML = html;
        }

        // Function to render radar chart using Chart.js
        function renderRadarChart(dimensions, values) {
            const ctx = document.getElementById('policyRadarChart').getContext('2d');

            // Make sure values are numbers and within 0-100 range for proper display
            const normalizedValues = values.map(v => {
                const num = parseFloat(v);
                return isNaN(num) ? 0 : Math.min(Math.max(num, 0), 100);
            });

            // If we have more than 6 dimensions, limit to 6 for clarity
            const displayDimensions = dimensions.length > 6 ? dimensions.slice(0, 6) : dimensions;
            const displayValues = normalizedValues.length > 6 ? normalizedValues.slice(0, 6) : normalizedValues;

            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: displayDimensions,
                    datasets: [{
                        label: 'æ”¿ç­–æ”¯æŒåŠ›åº¦',
                        data: displayValues,
                        backgroundColor: 'rgba(103, 58, 183, 0.2)',
                        borderColor: 'rgba(103, 58, 183, 1)',
                        pointBackgroundColor: 'rgba(103, 58, 183, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(103, 58, 183, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 25
                            }
                        }
                    }
                }
            });
        }

        // Initialize jsMind for mindmap
        let jm = null;

        function initMindmap() {
            // Check if jsMind library is available
            if (typeof jsMind === 'undefined') {
                console.error('jsMind library is not loaded');
                document.getElementById('mindmapSection').style.display = 'none';
                return null;
            }

            if (jm) {
                try {
                    jm.remove();
                } catch(e) {
                    // If remove fails, just set to null
                    jm = null;
                }
            }

            const options = {
                container: 'mindmapContainer',
                editable: false,
                theme: 'primary'
            };

            try {
                jm = new jsMind(options);
                return jm;
            } catch(e) {
                console.error('Error initializing jsMind:', e);
                document.getElementById('mindmapSection').style.display = 'none';
                return null;
            }
        }

        // Function to render mindmap from API data
        function renderMindmap(mindmapData) {
            if (!mindmapData) {
                console.error('No mindmap data provided');
                return;
            }

            // Check if jsMind library is available
            if (typeof jsMind === 'undefined') {
                console.error('jsMind library is not loaded');
                document.getElementById('mindmapSection').style.display = 'none';
                return;
            }

            const jm = initMindmap();

            // Set the data to the mindmap
            jm.show(mindmapData); // Pass the mindmap data directly

            // Show the mindmap section
            document.getElementById('mindmapSection').style.display = 'block';
        }

        // Function to generate mindmap from analysis result (local generation)
        function generateMindmapFromAnalysis(data) {
            try {
                // Check if jsMind library is available
                if (typeof jsMind === 'undefined') {
                    console.error('jsMind library is not loaded');
                    document.getElementById('mindmapSection').style.display = 'none';
                    return;
                }

                // Create mindmap data from the analysis result
                const mindmapData = createMindmapStructure(data);

                if (mindmapData) {
                    renderMindmap(mindmapData);  // Pass mindmapData directly, not as {data: mindmapData}
                } else {
                    document.getElementById('mindmapSection').style.display = 'none';
                }
            } catch (error) {
                console.error('Error creating mindmap from analysis:', error);
                document.getElementById('mindmapSection').style.display = 'none';
            }
        }

        // Create mindmap structure from analysis data
        function createMindmapStructure(data) {
            try {
                // Root node
                const rootNode = {
                    id: 'root',
                    topic: data.policy_metadata?.title || 'æ”¿ç­–åˆ†æ',
                    children: []
                };

                // Add metadata as branches
                if (data.policy_metadata) {
                    const metaChildren = [];

                    if (data.policy_metadata.issuing_authority) {
                        metaChildren.push({id: 'issuing_auth', topic: `å‘å¸ƒæœºæ„: ${data.policy_metadata.issuing_authority}`});
                    }
                    if (data.policy_metadata.publication_date) {
                        metaChildren.push({id: 'pub_date', topic: `å‘å¸ƒæ—¥æœŸ: ${data.policy_metadata.publication_date}`});
                    }
                    if (data.policy_metadata.applicable_regions && data.policy_metadata.applicable_regions.length > 0) {
                        metaChildren.push({id: 'regions', topic: `é€‚ç”¨åœ°åŒº: ${data.policy_metadata.applicable_regions.join(', ')}`});
                    }
                    if (data.policy_metadata.key_industries && data.policy_metadata.key_industries.length > 0) {
                        metaChildren.push({id: 'industries', topic: `é‡ç‚¹äº§ä¸š: ${data.policy_metadata.key_industries.join(', ')}`});
                    }

                    if (metaChildren.length > 0) {
                        rootNode.children.push({
                            id: 'metadata',
                            topic: 'åŸºæœ¬ä¿¡æ¯',
                            children: metaChildren
                        });
                    }
                }

                // Add key provisions
                if (data.provisions && data.provisions.length > 0) {
                    const provChildren = data.provisions.slice(0, 5).map((prov, idx) => {
                        const topic = typeof prov === 'string' ? prov : (prov.description || prov.type || '');
                        return {id: `prov_${idx}`, topic: topic};
                    }).filter(child => child.topic && child.topic.trim() !== '');

                    if (provChildren.length > 0) {
                        rootNode.children.push({
                            id: 'provisions',
                            topic: 'æ”¿ç­–æ¡æ¬¾',
                            children: provChildren
                        });
                    }
                }

                // Add key requirements
                if (data.requirements && data.requirements.length > 0) {
                    const reqChildren = data.requirements.slice(0, 5).map((req, idx) => {
                        const topic = typeof req === 'string' ? req : (req.requirement || req.description || '');
                        return {id: `req_${idx}`, topic: topic};
                    }).filter(child => child.topic && child.topic.trim() !== '');

                    if (reqChildren.length > 0) {
                        rootNode.children.push({
                            id: 'requirements',
                            topic: 'ç”³è¯·è¦æ±‚',
                            children: reqChildren
                        });
                    }
                }

                // Add quantitative data
                if (data.quantitative_data) {
                    const quantChildren = [];

                    if (data.quantitative_data.amounts && Array.isArray(data.quantitative_data.amounts) && data.quantitative_data.amounts.length > 0) {
                        const amounts = data.quantitative_data.amounts.slice(0, 3).map((amt, idx) => {
                            const topic = typeof amt === 'object' ? `${amt.amount || ''} ${amt.unit || ''}`.trim() : String(amt);
                            return {id: `amount_${idx}`, topic: topic || `é‡‘é¢${idx+1}`};
                        }).filter(child => child.topic && child.topic.trim() !== '');
                        if (amounts.length > 0) {
                            quantChildren.push({
                                id: 'amounts',
                                topic: `èµ„é‡‘æ”¯æŒ (${amounts.length})`,
                                children: amounts
                            });
                        }
                    }

                    if (data.quantitative_data.thresholds && Array.isArray(data.quantitative_data.thresholds) && data.quantitative_data.thresholds.length > 0) {
                        const thresholds = data.quantitative_data.thresholds.slice(0, 3).map((thresh, idx) => {
                            return {id: `thresh_${idx}`, topic: String(thresh) || `é—¨æ§›${idx+1}`};
                        }).filter(child => child.topic && child.topic.trim() !== '');
                        if (thresholds.length > 0) {
                            quantChildren.push({
                                id: 'thresholds',
                                topic: `é—¨æ§›æ¡ä»¶ (${thresholds.length})`,
                                children: thresholds
                            });
                        }
                    }

                    if (data.quantitative_data.ratios && Array.isArray(data.quantitative_data.ratios) && data.quantitative_data.ratios.length > 0) {
                        const ratios = data.quantitative_data.ratios.slice(0, 3).map((ratio, idx) => {
                            return {id: `ratio_${idx}`, topic: String(ratio) || `æ¯”ä¾‹${idx+1}`};
                        }).filter(child => child.topic && child.topic.trim() !== '');
                        if (ratios.length > 0) {
                            quantChildren.push({
                                id: 'ratios',
                                topic: `æ¯”ä¾‹æ•°æ® (${ratios.length})`,
                                children: ratios
                            });
                        }
                    }

                    if (quantChildren.length > 0) {
                        rootNode.children.push({
                            id: 'quantitative',
                            topic: 'é‡åŒ–æ•°æ®',
                            children: quantChildren
                        });
                    }
                }

                // Add timeline items
                if (data.timeline && data.timeline.length > 0) {
                    const timelineChildren = data.timeline.slice(0, 5).map((evt, idx) => {
                        let topic = '';
                        if (typeof evt === 'string') {
                            topic = evt;
                        } else {
                            const date = evt.date || '';
                            const content = evt.event || evt.content || `äº‹ä»¶${idx+1}`;
                            topic = date ? `${date}: ${content}` : content;
                        }
                        return {id: `timeline_${idx}`, topic: topic};
                    }).filter(child => child.topic && child.topic.trim() !== '');

                    if (timelineChildren.length > 0) {
                        rootNode.children.push({
                            id: 'timeline',
                            topic: 'æ—¶é—´è§„åˆ’',
                            children: timelineChildren
                        });
                    }
                }

                // Add key points
                if (data.key_points && data.key_points.length > 0) {
                    const kpChildren = data.key_points.slice(0, 5).map((kp, idx) => {
                        const topic = typeof kp === 'string' ? kp : (kp.title || kp.content || `è¦ç‚¹${idx+1}`);
                        return {id: `kp_${idx}`, topic: topic};
                    }).filter(child => child.topic && child.topic.trim() !== '');

                    if (kpChildren.length > 0) {
                        rootNode.children.push({
                            id: 'key_points',
                            topic: 'å…³é”®è¦ç‚¹',
                            children: kpChildren
                        });
                    }
                }

                return rootNode.children.length > 0 ? rootNode : null;
            } catch (error) {
                console.error('Error creating mindmap structure:', error);
                return null;
            }
        }

        // Function to load and display mindmap (kept for compatibility but won't be called)
        function loadAndRenderMindmap(formData) {
            console.warn('loadAndRenderMindmap is deprecated, using local generation instead');
        }

        // New render functions for the enhanced API response
        function renderPolicyMetadata(metadata, summary) {
            if (!metadata) return;

            let html = '';

            // Add summary prominently at the top if available
            if (summary) {
                html += `<div class="alert alert-primary">
                    <h6><strong>ğŸ“‹ æ”¿ç­–æ‘˜è¦</strong></h6>
                    <p class="mb-0">${summary}</p>
                </div>`;
            }

            html += '<div class="row"><div class="col-md-6"><table class="table table-sm">';
            html += `<tr><td><strong>æ”¿ç­–æ ‡é¢˜</strong></td><td>${metadata.title || 'N/A'}</td></tr>`;
            html += `<tr><td><strong>å‘æ–‡æœºå…³</strong></td><td>${metadata.issuing_authority || 'N/A'}</td></tr>`;
            html += `<tr><td><strong>å‘å¸ƒæ—¥æœŸ</strong></td><td>${metadata.publication_date || 'N/A'}</td></tr>`;
            html += '</table></div>';

            html += '<div class="col-md-6"><table class="table table-sm">';
            html += `<tr><td><strong>é€‚ç”¨åŒºåŸŸ</strong></td><td>${(metadata.applicable_regions || []).join(', ') || 'N/A'}</td></tr>`;
            html += `<tr><td><strong>é‡ç‚¹äº§ä¸š</strong></td><td>${(metadata.key_industries || []).join(', ') || 'N/A'}</td></tr>`;
            html += '</table></div></div>';

            document.getElementById('policyMetadata').innerHTML = html || '<p class="text-muted">æš‚æ— å…ƒæ•°æ®</p>';
        }

        function renderKeyPoints(points) {
            if (!points || points.length === 0) {
                document.getElementById('keyPoints').innerHTML = '<p class="text-muted">æš‚æ— è¦ç‚¹</p>';
                return;
            }

            let html = '<div class="list-group">';
            points.forEach((point, index) => {
                html += `<div class="list-group-item">
                    <span class="badge bg-primary me-2">${index + 1}</span>${point}
                </div>`;
            });
            html += '</div>';
            document.getElementById('keyPoints').innerHTML = html;
        }

        function renderProvisions(provisions) {
            const provisionsElement = document.getElementById('provisions');
            if (!provisionsElement) return; // Element doesn't exist, skip rendering

            if (!provisions || provisions.length === 0) {
                provisionsElement.innerHTML = '<p class="text-muted">æš‚æ— æ”¿ç­–æ¡æ¬¾</p>';
                return;
            }

            let html = '<div class="table-responsive"><table class="table table-sm table-striped">';
            html += '<thead><tr><th>æ¡æ¬¾ç±»å‹</th><th>å†…å®¹æè¿°</th></tr></thead><tbody>';
            provisions.forEach(prov => {
                const description = typeof prov === 'string' ? prov : (prov.description || prov.type || 'N/A');
                html += `<tr>
                    <td><strong>${prov.type || 'æ”¿ç­–æ¡æ¬¾'}</strong></td>
                    <td>${description}</td>
                </tr>`;
            });
            html += '</tbody></table></div>';
            document.getElementById('provisions').innerHTML = html;
        }

        function renderRequirements(requirements) {
            const requirementsElement = document.getElementById('requirements');
            if (!requirementsElement) return; // Element doesn't exist, skip rendering

            if (!requirements || requirements.length === 0) {
                requirementsElement.innerHTML = '<p class="text-muted">æš‚æ— ç”³è¯·è¦æ±‚</p>';
                return;
            }

            let html = '<div class="table-responsive"><table class="table table-sm table-striped">';
            html += '<thead><tr><th>è¦æ±‚ç±»å‹</th><th>å…·ä½“å†…å®¹</th></tr></thead><tbody>';
            requirements.forEach(req => {
                const requirement = typeof req === 'string' ? req : (req.requirement || 'N/A');
                const reqType = typeof req === 'string' ? 'è¦æ±‚' : (req.type || 'è¦æ±‚');

                html += `<tr>
                    <td><strong>${reqType}</strong></td>
                    <td>${requirement}</td>
                </tr>`;
            });
            html += '</tbody></table></div>';
            document.getElementById('requirements').innerHTML = html;
        }

        function renderQuantitativeData(quantitativeData) {
            const quantElement = document.getElementById('quantitativeData');
            if (!quantElement) return; // Element doesn't exist, skip rendering

            if (!quantitativeData || (!quantitativeData.amounts && !quantitativeData.thresholds && !quantitativeData.ratios && !quantitativeData.quantitative_indicators)) {
                quantElement.innerHTML = '<p class="text-muted">æš‚æ— é‡åŒ–æ•°æ®</p>';
                return;
            }

            let html = '';

            // Special display for dedicated quantitative indicators (these should be highlighted)
            const quantIndicators = quantitativeData.quantitative_indicators || [];
            if (quantIndicators.length > 0) {
                html += '<div class="alert alert-info"><h6><strong>ğŸ“Š é‡è¦é‡åŒ–æŒ‡æ ‡</strong></h6><ul class="mb-0">';
                quantIndicators.forEach(indicator => {
                    html += `<li><strong style="color: #d9534f; font-size: 1.1em;">${typeof indicator === 'string' ? indicator : JSON.stringify(indicator)}</strong></li>`;
                });
                html += '</ul></div>';
            }

            // Regular table for other data types
            const amounts = quantitativeData.amounts || [];
            const thresholds = quantitativeData.thresholds || [];
            const ratios = quantitativeData.ratios || [];

            if (amounts.length > 0 || thresholds.length > 0 || ratios.length > 0) {
                html += '<div class="table-responsive"><table class="table table-sm table-striped">';
                html += '<thead><tr><th>æ•°æ®ç±»å‹</th><th>å…·ä½“æ•°å€¼</th></tr></thead><tbody>';

                // Add amounts
                amounts.forEach(amount => {
                    html += `<tr>
                        <td><strong style="color: #5bc0de;">èµ„é‡‘é‡‘é¢</strong></td>
                        <td><strong style="color: #d9534f;">${amount}</strong></td>
                    </tr>`;
                });

                // Add thresholds
                thresholds.forEach(threshold => {
                    html += `<tr>
                        <td><strong style="color: #5bc0de;">é—¨æ§›æ¡ä»¶</strong></td>
                        <td><strong style="color: #d9534f;">${threshold}</strong></td>
                    </tr>`;
                });

                // Add ratios
                ratios.forEach(ratio => {
                    html += `<tr>
                        <td><strong style="color: #5bc0de;">æ¯”ä¾‹æ•°æ®</strong></td>
                        <td><strong style="color: #d9534f;">${ratio}</strong></td>
                    </tr>`;
                });

                html += '</tbody></table></div>';
            }

            if (!html) {
                html = '<p class="text-muted">æš‚æ— é‡åŒ–æ•°æ®</p>';
            }

            document.getElementById('quantitativeData').innerHTML = html;
        }

        function renderTimeline(timeline) {
            const timelineElement = document.getElementById('timeline');
            if (!timelineElement) return; // Element doesn't exist, skip rendering

            if (!timeline || timeline.length === 0) {
                timelineElement.innerHTML = '<p class="text-muted">æš‚æ— æ—¶é—´è½´æ•°æ®</p>';
                return;
            }

            let html = '<div class="list-group">';
            timeline.forEach(event => {
                const date = typeof event === 'string' ? '' : (event.date || 'N/A');
                const content = typeof event === 'string' ? event : (event.content || event.event || 'N/A');
                const eventType = typeof event === 'string' ? 'äº‹ä»¶' : (event.type || 'äº‹ä»¶');

                html += `<div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${date}</h6>
                        <small class="text-muted">${eventType}</small>
                    </div>
                    <p class="mb-1">${content}</p>
                </div>`;
            });
            html += '</div>';
            if (timelineElement) {
                timelineElement.innerHTML = html;
            }
        }

        function renderAdvancedAnalysis(analysis) {
            if (!analysis) return;

            // Industry relevance
            const valueChain = analysis.industry_relevance?.value_chain || {};
            let chainHtml = '<div class="card"><div class="card-body"><h6 class="card-title">äº§ä¸šé“¾å…³ç³»</h6>';
            chainHtml += '<div class="row">';
            chainHtml += `<div class="col"><strong>ä¸Šæ¸¸:</strong> ${(valueChain.upstream || []).join(', ') || 'æ— '}</div>`;
            chainHtml += `<div class="col"><strong>ä¸­æ¸¸:</strong> ${(valueChain.midstream || []).join(', ') || 'æ— '}</div>`;
            chainHtml += `<div class="col"><strong>ä¸‹æ¸¸:</strong> ${(valueChain.downstream || []).join(', ') || 'æ— '}</div>`;
            chainHtml += '</div></div></div>';

            const industryRelevanceElement = document.getElementById('industryRelevance');
            if (industryRelevanceElement) {
                industryRelevanceElement.innerHTML = chainHtml;
            }

            // Policy strength
            const strength = analysis.policy_strength || {};
            let strengthHtml = '<div class="card"><div class="card-body"><h6 class="card-title">æ”¿ç­–åŠ›åº¦è¯„ä¼°</h6>';
            strengthHtml += `<p><strong>èµ„é‡‘ç­‰çº§:</strong> ${strength.funding_level || 'N/A'}</p>`;
            strengthHtml += `<p><strong>æªæ–½å¤šæ ·æ€§:</strong> ${strength.measure_diversity || 0} é¡¹</p>`;
            strengthHtml += `<p><strong>è¦†ç›–å…¨é¢æ€§:</strong> ${strength.support_comprehensiveness || 'N/A'}</p>`;
            strengthHtml += '</div></div>';

            const policyStrengthElement = document.getElementById('policyStrength');
            if (policyStrengthElement) {
                policyStrengthElement.innerHTML = strengthHtml;
            }

            // Timeliness and regional match
            let analysisHtml = '<div class="row"><div class="col-md-6">';
            analysisHtml += `<div class="card"><div class="card-body"><h6 class="card-title">æ—¶æ•ˆæ€§åˆ†æ</h6>`;
            analysisHtml += `<p>æ—¶æ•ˆæ€§è¯„åˆ†: <strong>${analysis.timeliness_score || 0}</strong>/100</p></div></div>`;
            analysisHtml += '</div><div class="col-md-6">';
            analysisHtml += `<div class="card"><div class="card-body"><h6 class="card-title">åŒºåŸŸåŒ¹é…åº¦</h6>`;
            analysisHtml += `<p>åŒ¹é…åº¦è¯„åˆ†: <strong>${analysis.regional_match_score || 0}</strong>/100</p></div></div>`;
            analysisHtml += '</div></div>';

            const timelinessRegionalElement = document.getElementById('timelinessRegional');
            if (timelinessRegionalElement) {
                timelinessRegionalElement.innerHTML = analysisHtml;
            }
        }

        // Mindmap control handlers
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('expandAllMindmap').addEventListener('click', function() {
                if (jm) {
                    jm.expand_all();
                }
            });

            document.getElementById('collapseAllMindmap').addEventListener('click', function() {
                if (jm) {
                    jm.collapse_all();
                }
            });

            document.getElementById('exportMindmap').addEventListener('click', function() {
                if (jm) {
                    // Simple export as image (in a real implementation, would need to use jsMind's export functionality)
                    if (confirm("æ˜¯å¦å¯¼å‡ºæ€ç»´å¯¼å›¾ä¸ºPNGå›¾ç‰‡?")) {
                        alert("åŠŸèƒ½å¼€å‘ä¸­ï¼šæ€ç»´å¯¼å›¾å¯¼å‡ºåŠŸèƒ½");
                    }
                }
            });
        });

        let managedLinks = [];

        async function loadDataSources() {
            try {
                const resp = await fetch('/api/data-sources');
                const json = await resp.json();
                const tbody = document.querySelector('#dataSourcesTable tbody');
                tbody.innerHTML = '';
                (json.sources || []).forEach(s => {
                    const tr = document.createElement('tr');
                    const q = s.quality || {};
                    tr.innerHTML = `<td>${s.provider}</td><td><a href="${s.url}" target="_blank" rel="noopener noreferrer" data-safe-link="1">${s.name}</a></td><td>${s.last_update||''}</td><td>${(s.format||[]).join('/')}</td><td>${s.verified ? '<span class="badge bg-success">å·²éªŒè¯</span>' : '<span class="badge bg-secondary">å¾…éªŒè¯</span>'}</td><td>å®Œ:${Math.round((q.completeness||0)*100)}% å‡†:${Math.round((q.accuracy||0)*100)}% é€Ÿ:${Math.round((q.freshness||0)*100)}%</td>`;
                    tbody.appendChild(tr);
                });
                bindSafeLinkClicks();
            } catch {}
        }

        async function loadLinks() {
            try {
                const resp = await fetch('/api/links');
                const json = await resp.json();
                managedLinks = json.links || [];
                renderLinks(managedLinks);
            } catch {}
        }

        function renderLinks(links) {
            const q = (document.getElementById('linkSearchInput').value || '').toLowerCase();
            const type = document.getElementById('linkTypeFilter').value || '';
            const imp = document.getElementById('linkImportanceFilter').value || '';
            const list = document.getElementById('linksList');
            list.innerHTML = '';
            links.filter(l => {
                const matchQ = q ? (l.url.toLowerCase().includes(q)) : true;
                const matchT = type ? (l.type === type) : true;
                const matchI = imp ? (l.importance === imp) : true;
                return matchQ && matchT && matchI;
            }).forEach(l => {
                const item = document.createElement('div');
                const https = l.url.startsWith('https://');
                item.className = 'list-group-item d-flex justify-content-between align-items-start';
                item.innerHTML = `<div class="ms-2 me-auto"><div class="fw-bold"><a href="${l.url}" target="_blank" rel="noopener noreferrer" data-safe-link="1">${l.url}</a></div><small class="text-muted">ç±»å‹ï¼š${l.type}ï½œé‡è¦æ€§ï¼š${l.importance}</small></div><span class="badge ${https ? 'bg-success' : 'bg-warning text-dark'}">${https ? 'HTTPS' : 'éHTTPS'}</span>`;
                list.appendChild(item);
            });
            bindSafeLinkClicks();
        }

        document.getElementById('linkSearchInput').addEventListener('input', () => renderLinks(managedLinks));
        document.getElementById('linkTypeFilter').addEventListener('change', () => renderLinks(managedLinks));
        document.getElementById('linkImportanceFilter').addEventListener('change', () => renderLinks(managedLinks));

        document.getElementById('checkLinksBtn').addEventListener('click', async () => {
            try {
                const payload = { links: managedLinks };
                const resp = await fetch('/api/link-check', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const json = await resp.json();
                const map = {};
                (json.results || []).forEach(r => { map[r.url] = r; });
                const list = document.getElementById('linksList');
                [...list.querySelectorAll('div.list-group-item')].forEach(div => {
                    const a = div.querySelector('a[data-safe-link]');
                    if (a && map[a.href]) {
                        const r = map[a.href];
                        const badge = document.createElement('span');
                        badge.className = r.reachable ? 'badge bg-success ms-2' : 'badge bg-danger ms-2';
                        badge.textContent = r.reachable ? 'æœ‰æ•ˆ' : 'æ— æ•ˆ';
                        a.parentElement.appendChild(badge);
                    }
                });
            } catch {}
        });

        function bindSafeLinkClicks() {
            document.querySelectorAll('a[data-safe-link="1"]').forEach(a => {
                a.addEventListener('click', async function(e) {
                    e.preventDefault();
                    const url = this.href;
                    const modalHtml = `<div class="modal" tabindex="-1" id="safeModal"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">å¤–éƒ¨é“¾æ¥å®‰å…¨æç¤º</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="å…³é—­"></button></div><div class="modal-body"><p>å³å°†æ‰“å¼€å¤–éƒ¨é“¾æ¥ï¼š</p><p class="text-break">${url}</p><p class="small text-muted">è¯·ç¡®è®¤é“¾æ¥æ¥æºå¯ä¿¡ï¼Œæ³¨æ„ä¿¡æ¯å®‰å…¨ã€‚</p></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button><button type="button" class="btn btn-primary" id="confirmOpen">ç»§ç»­æ‰“å¼€</button></div></div></div></div>`;
                    const wrapper = document.createElement('div');
                    wrapper.innerHTML = modalHtml;
                    document.body.appendChild(wrapper);
                    const modal = new bootstrap.Modal(wrapper.querySelector('#safeModal'));
                    modal.show();
                    wrapper.querySelector('#confirmOpen').onclick = async () => {
                        try { await fetch('/api/links/click', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ url }) }); } catch {}
                        window.open(url, '_blank', 'noopener');
                        modal.hide();
                        document.body.removeChild(wrapper);
                    };
                    wrapper.querySelector('.btn-close').onclick = () => { document.body.removeChild(wrapper); };
                });
            });
        }

        // Set default values for region and industry tags
        document.addEventListener('DOMContentLoaded', function() {
            const regionInput = document.getElementById('regionInput');
            const industryTagsInput = document.getElementById('industryTagsInput');

            if (regionInput.value.trim() === '') {
                regionInput.value = 'å››å·çœ';
            }

            if (industryTagsInput.value.trim() === '') {
                industryTagsInput.value = 'äººå·¥æ™ºèƒ½';
            }
        });

        // Tab state management - preserve results when switching tabs
        let tabStates = {
            'search-tab': {
                resultContent: '',
                policySearchResults: '',
                dataSourcesTable: '',
                linksList: ''
            },
            'upload-tab': {
                resultContent: '',
                semanticAnalysis: '',
                contentClassification: '',
                visualizationArea: '',
                policyResults: 'none' // Store the display state
            }
        };

        function saveTabState(tabId) {
            if (tabId === 'search-tab') {
                const resultContentElement = document.getElementById('resultContent');
                const policySearchResultsElement = document.getElementById('policySearchResults');
                const dataSourcesTbody = document.querySelector('#dataSourcesTable tbody');
                const linksListElement = document.getElementById('linksList');

                tabStates['search-tab'].resultContent = resultContentElement ? resultContentElement.innerHTML : '';
                tabStates['search-tab'].policySearchResults = policySearchResultsElement ? policySearchResultsElement.innerHTML : '';
                tabStates['search-tab'].dataSourcesTable = dataSourcesTbody ? dataSourcesTbody.innerHTML : '';
                tabStates['search-tab'].linksList = linksListElement ? linksListElement.innerHTML : '';
            } else if (tabId === 'upload-tab') {
                const resultContentElement = document.getElementById('resultContent');
                const semanticAnalysisElement = document.getElementById('semanticAnalysis');
                const contentClassificationElement = document.getElementById('contentClassification');
                const visualizationAreaElement = document.getElementById('visualizationArea');
                const policyResultsElement = document.getElementById('policyResults');

                tabStates['upload-tab'].resultContent = resultContentElement ? resultContentElement.innerHTML : '';
                tabStates['upload-tab'].semanticAnalysis = semanticAnalysisElement ? semanticAnalysisElement.innerHTML : '';
                tabStates['upload-tab'].contentClassification = contentClassificationElement ? contentClassificationElement.innerHTML : '';
                tabStates['upload-tab'].visualizationArea = visualizationAreaElement ? visualizationAreaElement.innerHTML : '';
                tabStates['upload-tab'].policyResults = policyResultsElement ? policyResultsElement.style.display : 'none';
            }
        }

        function restoreTabState(tabId) {
            if (tabId === 'search-tab') {
                const resultContentElement = document.getElementById('resultContent');
                const policySearchResultsElement = document.getElementById('policySearchResults');
                const dataSourcesTbody = document.querySelector('#dataSourcesTable tbody');
                const linksListElement = document.getElementById('linksList');

                if (resultContentElement) {
                    resultContentElement.innerHTML = tabStates['search-tab'].resultContent;
                }
                if (policySearchResultsElement) {
                    policySearchResultsElement.innerHTML = tabStates['search-tab'].policySearchResults;
                }
                if (dataSourcesTbody) {
                    dataSourcesTbody.innerHTML = tabStates['search-tab'].dataSourcesTable;
                }
                if (linksListElement) {
                    linksListElement.innerHTML = tabStates['search-tab'].linksList;
                }
            } else if (tabId === 'upload-tab') {
                const resultContentElement = document.getElementById('resultContent');
                const semanticAnalysisElement = document.getElementById('semanticAnalysis');
                const contentClassificationElement = document.getElementById('contentClassification');
                const visualizationAreaElement = document.getElementById('visualizationArea');
                const policyResultsElement = document.getElementById('policyResults');

                if (resultContentElement) {
                    resultContentElement.innerHTML = tabStates['upload-tab'].resultContent;
                }
                if (semanticAnalysisElement) {
                    semanticAnalysisElement.innerHTML = tabStates['upload-tab'].semanticAnalysis;
                }
                if (contentClassificationElement) {
                    contentClassificationElement.innerHTML = tabStates['upload-tab'].contentClassification;
                }
                if (visualizationAreaElement) {
                    visualizationAreaElement.innerHTML = tabStates['upload-tab'].visualizationArea;
                }
                if (policyResultsElement) {
                    policyResultsElement.style.display = tabStates['upload-tab'].policyResults;
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const tabTriggerList = [].slice.call(document.querySelectorAll('button[data-bs-toggle="tab"]'));

            tabTriggerList.forEach(function(tabTrigger) {
                tabTrigger.addEventListener('hide.bs.tab', function(event) {
                    // Save the state of the tab being left
                    saveTabState(event.target.id);
                });

                tabTrigger.addEventListener('shown.bs.tab', function(event) {
                    // Restore the state of the tab being shown
                    restoreTabState(event.target.id);
                });
            });
        });

        // WeChat Public Account functionality
        document.getElementById('fetchWechatArticlesBtn').addEventListener('click', async function() {
            const region = document.getElementById('wechatRegion').value.trim();
            const industry = document.getElementById('wechatIndustry').value.trim();

            if (!region || !industry) {
                alert('è¯·è¾“å…¥åŒºåŸŸå’Œäº§ä¸šåç§°');
                return;
            }

            try {
                document.getElementById('wechatLoading').style.display = 'block';
                document.getElementById('wechatArticlesResults').innerHTML = '';

                const response = await fetch('/api/wechat-articles', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        region: region,
                        industry: industry,
                        limit: 10
                    })
                });

                const data = await response.json();

                document.getElementById('wechatLoading').style.display = 'none';

                if (!data.success) {
                    alert(data.error || 'è·å–å¾®ä¿¡å…¬ä¼—å·æ–‡ç« å¤±è´¥');
                    return;
                }

                renderWechatArticles(data.articles);

            } catch (error) {
                document.getElementById('wechatLoading').style.display = 'none';
                alert('è·å–å¾®ä¿¡å…¬ä¼—å·æ–‡ç« å¤±è´¥: ' + error.message);
            }
        });

        document.getElementById('searchWechatBtn').addEventListener('click', function() {
            // Show the search keywords section
            document.getElementById('wechatSearchKeywordsSection').style.display = 'block';

            // Set up search functionality
            document.getElementById('wechatSearchKeywords').onkeydown = async function(event) {
                if (event.key === 'Enter') {
                    await performWechatSearch();
                }
            };
        });

        async function performWechatSearch() {
            const region = document.getElementById('wechatRegion').value.trim();
            const keywordsText = document.getElementById('wechatSearchKeywords').value.trim();

            if (!keywordsText) {
                alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                return;
            }

            const keywords = keywordsText.split(',').map(k => k.trim()).filter(k => k);

            try {
                document.getElementById('wechatLoading').style.display = 'block';
                document.getElementById('wechatArticlesResults').innerHTML = '';

                const response = await fetch('/api/wechat-search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        keywords: keywords,
                        region: region,
                        limit: 10
                    })
                });

                const data = await response.json();

                document.getElementById('wechatLoading').style.display = 'none';

                if (!data.success) {
                    alert(data.error || 'æœç´¢å¾®ä¿¡å…¬ä¼—å·æ–‡ç« å¤±è´¥');
                    return;
                }

                renderWechatArticles(data.articles);

            } catch (error) {
                document.getElementById('wechatLoading').style.display = 'none';
                alert('æœç´¢å¾®ä¿¡å…¬ä¼—å·æ–‡ç« å¤±è´¥: ' + error.message);
            }
        }

        document.getElementById('fetchAccountArticlesBtn').addEventListener('click', async function() {
            const accountName = document.getElementById('wechatAccount').value.trim();

            if (!accountName) {
                alert('è¯·è¾“å…¥å…¬ä¼—å·åç§°');
                return;
            }

            try {
                document.getElementById('wechatLoading').style.display = 'block';
                document.getElementById('wechatArticlesResults').innerHTML = '';

                const response = await fetch('/api/wechat-account-articles', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        account_name: accountName,
                        limit: 10
                    })
                });

                const data = await response.json();

                document.getElementById('wechatLoading').style.display = 'none';

                if (!data.success) {
                    alert(data.error || 'è·å–å…¬ä¼—å·æ–‡ç« å¤±è´¥');
                    return;
                }

                renderWechatArticles(data.articles);

            } catch (error) {
                document.getElementById('wechatLoading').style.display = 'none';
                alert('è·å–å…¬ä¼—å·æ–‡ç« å¤±è´¥: ' + error.message);
            }
        });

        function renderWechatArticles(articles) {
            const container = document.getElementById('wechatArticlesResults');

            if (!articles || articles.length === 0) {
                container.innerHTML = '<div class="col-12"><p class="text-muted">æœªæ‰¾åˆ°ç›¸å…³å¾®ä¿¡å…¬ä¼—å·æ–‡ç« </p></div>';
                return;
            }

            let html = '';
            articles.forEach((article, index) => {
                html += `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h6 class="card-title">${article.title}</h6>
                            <p class="card-text small text-muted">
                                <small>
                                    <strong>å…¬ä¼—å·:</strong> ${article.source_account}<br>
                                    <strong>ä½œè€…:</strong> ${article.author}<br>
                                    <strong>æ—¥æœŸ:</strong> ${article.publish_date}<br>
                                    <strong>ç›¸å…³äº§ä¸š:</strong> ${article.industry_relevance && article.industry_relevance.length > 0 ? article.industry_relevance.join(', ') : 'æœªçŸ¥'}
                                </small>
                            </p>
                            <p class="card-text">${article.summary.substring(0, 100)}${article.summary.length > 100 ? '...' : ''}</p>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <strong>å…³é”®è¯:</strong> ${article.keywords && article.keywords.length > 0 ? article.keywords.slice(0, 3).join(', ') : 'æ— '}
                                </small>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="btn-group w-100" role="group">
                                <button type="button" class="btn btn-outline-primary btn-sm"
                                    onclick="viewWechatArticle('${article.title}', '${article.content}', '${article.source_account}', '${article.publish_date}', '${article.url}', '${encodeURIComponent(JSON.stringify(article))}')">
                                    è¯¦æƒ…
                                </button>
                                <button type="button" class="btn btn-outline-success btn-sm"
                                    onclick="analyzeWechatArticle('${encodeURIComponent(JSON.stringify(article))}')">
                                    åˆ†æ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            });

            container.innerHTML = html;
        }

        function viewWechatArticle(title, content, sourceAccount, publishDate, url, articleData) {
            // Update the main result content area with the article content
            document.getElementById('resultContent').innerHTML = `
                <h4>${title}</h4>
                <small class="text-muted">
                    <strong>å…¬ä¼—å·:</strong> ${sourceAccount} |
                    <strong>å‘å¸ƒæ—¥æœŸ:</strong> ${publishDate} |
                    <a href="${url}" target="_blank" rel="noopener noreferrer" data-safe-link="1">åŸæ–‡é“¾æ¥</a>
                </small>
                <div class="mt-3">${content}</div>
            `;
            bindSafeLinkClicks();
        }

        async function analyzeWechatArticle(articleDataEncoded) {
            try {
                const article = JSON.parse(decodeURIComponent(articleDataEncoded));

                document.getElementById('wechatLoading').style.display = 'block';

                const response = await fetch('/api/wechat-analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: article.content,
                        title: article.title,
                        source_account: article.source_account,
                        publish_date: article.publish_date,
                        author: article.author,
                        url: article.url
                    })
                });

                const data = await response.json();

                document.getElementById('wechatLoading').style.display = 'none';

                if (!data.success) {
                    alert(data.error || 'åˆ†ææ–‡ç« å¤±è´¥');
                    return;
                }

                // Display analysis results in the main content area
                const analysis = data.analysis;
                let analysisHtml = `
                    <h4>æ–‡ç« åˆ†æç»“æœ: ${article.title}</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header"><strong>æ”¿ç­–è¦ç‚¹</strong></div>
                                <div class="card-body">
                                    <ul class="list-group list-group-flush">
                `;

                (analysis.policy_analysis.highlights || []).slice(0, 5).forEach(highlight => {
                    analysisHtml += `<li class="list-group-item">${highlight.content}</li>`;
                });

                analysisHtml += `
                                    </ul>
                                </div>
                            </div>

                            <div class="card mb-3">
                                <div class="card-header"><strong>è¡¥è´´ä¿¡æ¯</strong></div>
                                <div class="card-body">
                                    <ul class="list-group list-group-flush">
                `;

                (analysis.policy_analysis.subsidies_and_taxes.subsidies || []).forEach(subsidy => {
                    analysisHtml += `<li class="list-group-item">${subsidy.description}</li>`;
                });

                analysisHtml += `
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header"><strong>æ—¶é—´è½´</strong></div>
                                <div class="card-body">
                                    <ul class="list-group list-group-flush">
                `;

                (analysis.policy_analysis.timeline || []).forEach(event => {
                    analysisHtml += `<li class="list-group-item"><strong>${event.date}</strong> - ${event.context}</li>`;
                });

                analysisHtml += `
                                    </ul>
                                </div>
                            </div>

                            <div class="card mb-3">
                                <div class="card-header"><strong>æƒ…æ„Ÿåˆ†æ</strong></div>
                                <div class="card-body">
                                    <p><strong>æ•´ä½“å€¾å‘:</strong> ${analysis.sentiment.overall}</p>
                                    <p><strong>æ­£é¢æƒ…ç»ª:</strong> ${(analysis.sentiment.positive * 100).toFixed(1)}%</p>
                                    <p><strong>è´Ÿé¢æƒ…ç»ª:</strong> ${(analysis.sentiment.negative * 100).toFixed(1)}%</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('resultContent').innerHTML = analysisHtml;

            } catch (error) {
                document.getElementById('wechatLoading').style.display = 'none';
                alert('åˆ†ææ–‡ç« å¤±è´¥: ' + error.message);
            }
        }

        // Add search button click handler
        document.getElementById('wechatSearchKeywords').addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent form submission
                performWechatSearch();
            }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
