<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>政策分析工作台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --accent-color: #4cc9f0;
            --success-color: #4ade80;
            --warning-color: #facc15;
            --danger-color: #f87171;
            --dark-bg: #0f172a;
            --card-bg: #ffffff;
            --sidebar-bg: #1e293b;
            --hover-bg: #f1f5f9;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #f8fafc;
            font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: #1e293b;
            overflow-x: hidden;
        }
        
        /* Modern gradient navbar */
        .navbar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            height: 64px;
            z-index: 1000;
        }
        
        .navbar-brand {
            font-weight: 700;
            letter-spacing: -0.02em;
        }
        
        .navbar-nav .nav-link {
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .navbar-nav .nav-link:hover {
            color: rgba(255, 255, 255, 0.9) !important;
            transform: translateY(-1px);
        }
        
        /* Modern sidebar with glass morphism effect */
        .sidebar {
            width: 260px;
            background: var(--sidebar-bg);
            color: white;
            position: fixed;
            top: 64px;
            left: 0;
            bottom: 0;
            overflow-y: auto;
            z-index: 100;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-section {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .sidebar-section h6 {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 16px;
        }
        
        .sidebar-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            transition: all 0.2s ease;
            width: 100%;
            margin-bottom: 12px;
            padding: 12px 16px;
            border-radius: 12px;
            text-align: left;
        }
        
        .sidebar-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(4px);
            border-color: var(--accent-color);
        }
        
        .sidebar-btn i {
            margin-right: 12px;
            width: 20px;
            text-align: center;
        }
        
        /* Main content area */
        .main-content {
            margin-left: 260px;
            padding: 24px;
            min-height: calc(100vh - 64px);
            background: #f8fafc;
        }
        
        .main-header {
            margin-bottom: 32px;
        }
        
        .main-header h2 {
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
        }
        
        .search-container {
            background: white;
            border-radius: 16px;
            padding: 4px 16px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
            max-width: 400px;
        }
        
        .search-container:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.15);
        }
        
        .search-container i {
            color: #94a3b8;
            margin-right: 8px;
        }
        
        .search-input {
            border: none;
            outline: none;
            width: 100%;
            padding: 12px 0;
            font-size: 0.9rem;
        }
        
        /* Policy list container with modern design */
        .policy-list-container {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }
        
        .list-header {
            padding: 20px 24px;
            background: linear-gradient(135deg, #f8fafc, #ffffff);
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .list-header h5 {
            font-weight: 600;
            color: #1e293b;
            margin: 0;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        /* Policy items - email style list */
        .policy-list {
            max-height: calc(100vh - 400px);
            overflow-y: auto;
        }
        
        .policy-item {
            padding: 16px 24px;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            border-left: 4px solid transparent;
        }
        
        .policy-item:hover {
            background: var(--hover-bg);
            transform: translateX(4px);
            border-left-color: var(--primary-color);
        }
        
        .policy-item.unread {
            background: linear-gradient(to right, #f0f9ff, #ffffff);
            border-left-color: var(--primary-color);
        }
        
        .policy-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .policy-title {
            font-weight: 600;
            color: #1e293b;
            font-size: 0.95rem;
            line-height: 1.4;
            flex: 1;
        }
        
        .policy-time {
            font-size: 0.8rem;
            color: #64748b;
            white-space: nowrap;
            margin-left: 12px;
        }
        
        .policy-summary {
            font-size: 0.85rem;
            color: #64748b;
            line-height: 1.5;
            margin-bottom: 12px;
        }
        
        .policy-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .policy-tag {
            background: #e2e8f0;
            color: #475569;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .region-tag { background: #dbeafe; color: #1e40af; }
        .industry-tag { background: #dcfce7; color: #166534; }
        .year-tag { background: #fef3c7; color: #92400e; }
        .type-tag { background: #ede9fe; color: #6d28d9; }
        .processing-tag { background: #fb7185; color: white; }
        
        /* Modern pagination */
        .modern-pagination {
            padding: 24px;
            text-align: center;
            border-top: 1px solid #e2e8f0;
            background: #f8fafc;
        }
        
        .modern-pagination .page-link {
            border: 1px solid #e2e8f0;
            color: var(--primary-color);
            border-radius: 10px !important;
            margin: 0 2px;
            width: 40px;
            height: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .modern-pagination .page-link:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }
        
        .modern-pagination .page-item.active .page-link {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
        }
        
        /* Status indicators */
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 6px;
        }
        
        .status-pending { background: #fbbf24; }
        .status-processing { background: #3b82f6; animation: pulse 2s infinite; }
        .status-completed { background: #10b981; }
        .status-failed { background: #ef4444; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Floating action button */
        .fab {
            position: fixed;
            bottom: 32px;
            right: 32px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            box-shadow: 0 10px 25px rgba(67, 97, 238, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .fab:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 15px 35px rgba(67, 97, 238, 0.5);
        }
        
        .fab i {
            font-size: 24px;
        }
        
        /* Loading states */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Toast notifications */
        .toast-custom {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .stats-row {
            margin-bottom: 32px;
        }
        
        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            text-align: center;
            transition: transform 0.3s ease;
            border: 1px solid #e2e8f0;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 10px 0;
        }
        
        .stat-label {
            color: #64748b;
            font-size: 0.9em;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid px-4">
            <a class="navbar-brand d-flex align-items-center" href="{{ url_for('index') }}">
                <i class="fas fa-brain me-2"></i>
                <span class="fw-bold">政策分析平台</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('index') }}"><i class="fas fa-home me-1"></i>首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('generate_report') }}"><i class="fas fa-file-alt me-1"></i>报告生成</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="{{ url_for('policy_analysis_dashboard') }}"><i class="fas fa-file-contract me-1"></i>政策解读</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user me-2"></i>{{ current_user.username }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt me-2 text-danger"></i>退出登录</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row" style="min-height: calc(100vh - 64px);">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <h5 class="mb-0"><i class="fas fa-toolbox me-2"></i>工作台</h5>
                </div>
                
                <div class="sidebar-section">
                    <h6>快速操作</h6>
                    <button class="btn sidebar-btn" data-bs-toggle="modal" data-bs-target="#addPolicyModal">
                        <i class="fas fa-plus"></i> 手动添加URL
                    </button>
                    <button class="btn sidebar-btn" id="checkEmailBtn">
                        <i class="fas fa-envelope"></i> 检查新邮件
                    </button>
                    <button class="btn sidebar-btn" id="batchActionsBtn" data-bs-toggle="modal" data-bs-target="#batchActionsModal">
                        <i class="fas fa-bolt"></i> 批量操作
                    </button>
                    <button class="btn sidebar-btn" id="qwenCliAnalysisBtn">
                        <i class="fas fa-robot"></i> Qwen CLI分析
                    </button>
                </div>
                
                <div class="sidebar-section">
                    <h6>分类筛选</h6>
                    <div class="mb-3">
                        <label class="form-label text-white-50">区域</label>
                        <select class="form-select form-select-sm" id="regionFilter">
                            <option value="">全部区域</option>
                            <!-- Regions will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-white-50">行业</label>
                        <select class="form-select form-select-sm" id="industryFilter">
                            <option value="">全部行业</option>
                            <!-- Industries will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-white-50">年份</label>
                        <select class="form-select form-select-sm" id="yearFilter">
                            <option value="">全部年份</option>
                            <!-- Years will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-white-50">政策类型</label>
                        <select class="form-select form-select-sm" id="typeFilter">
                            <option value="">全部类型</option>
                            <option value="扶持政策">扶持政策</option>
                            <option value="税收优惠">税收优惠</option>
                            <option value="准入政策">准入政策</option>
                            <option value="监管政策">监管政策</option>
                            <option value="发展规划">发展规划</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <div class="main-header d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-code me-3"></i>Qwen Code 政策解读</h2>
                    <div class="d-flex align-items-center gap-3">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPolicyModal">
                            <i class="fas fa-plus me-1"></i>手动添加
                        </button>
                        <div class="search-container d-flex align-items-center">
                            <i class="fas fa-search"></i>
                            <input type="text" class="search-input" id="globalSearch" placeholder="搜索政策标题、内容...">
                        </div>
                    </div>
                </div>

                <!-- Stats Row -->
                <div class="row stats-row">
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number" id="totalPolicies">0</div>
                            <div class="stat-label">政策总数</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number" id="newThisWeek">0</div>
                            <div class="stat-label">本周新增</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number" id="regionsCount">0</div>
                            <div class="stat-label">覆盖区域</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number" id="industriesCount">0</div>
                            <div class="stat-label">涉及行业</div>
                        </div>
                    </div>
                </div>

                <!-- Policy List Container -->
                <div class="policy-list-container">
                    <div class="list-header">
                        <h5><i class="fas fa-list me-2"></i>政策列表</h5>
                        <div class="header-actions">
                            <small class="text-muted">共 <span id="policyCount">0</span> 条政策</small>
                        </div>
                    </div>
                    <div class="policy-list" id="policyList">
                        <!-- Policies will be loaded here -->
                        <div class="d-flex justify-content-center align-items-center p-5 text-muted">
                            <div class="text-center">
                                <i class="fas fa-inbox fa-3x mb-3" style="color: #cbd5e1;"></i>
                                <p class="mb-0">暂无政策数据</p>
                                <small class="text-muted">点击"+"按钮添加政策或检查新邮件</small>
                            </div>
                        </div>
                    </div>
                    <div class="modern-pagination" id="pagination">
                        <!-- Pagination will be loaded here -->
                    </div>
                </div>
                
                <!-- Add Policy Modal -->
                <div class="modal fade" id="addPolicyModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">发送文本给Qwen Code助手</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="policyUrl" class="form-label">政策文章URL</label>
                                    <input type="url" class="form-control" id="policyUrl" placeholder="https://example.com/policy-article" required>
                                    <div class="form-text">请输入政策文章的完整URL</div>
                                </div>
                                <div id="analysisStatus" style="display: none;">
                                    <div class="progress mb-3">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" id="progressBar" role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <div class="text-center">
                                        <i class="fas fa-spinner fa-spin me-2"></i> 
                                        <span id="statusText">正在分析政策...</span>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                <button type="button" class="btn btn-primary" id="addPolicySubmitBtn">添加并分析</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <button class="fab" id="addPolicyFab" data-bs-toggle="modal" data-bs-target="#addPolicyModal">
        <i class="fas fa-robot"></i>
    </button>

    <!-- Batch Actions Modal -->
    <div class="modal fade" id="batchActionsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">批量操作</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">选择操作类型</label>
                        <select class="form-select" id="batchActionType">
                            <option value="delete">删除选中政策</option>
                            <option value="reanalyze">重新分析选中政策</option>
                            <option value="export">导出选中政策</option>
                            <option value="classify">重新分类选中政策</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="selectAllCheckbox">
                            <label class="form-check-label" for="selectAllCheckbox">
                                全选当前页面政策
                            </label>
                        </div>
                    </div>
                    <div id="selectedCount" class="text-muted">
                        已选择 0 条政策
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            提示：按住Ctrl键可多选政策
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="executeBatchActionBtn">执行操作</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div aria-live="polite" aria-atomic="true" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100;">
        <div id="liveToast" class="toast toast-custom hide" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto" id="toastTitle">系统通知</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastBody">
                操作成功！
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPage = 1;
        const itemsPerPage = 50;
        let allPolicies = [];
        let filteredPolicies = [];
        let regions = {{ regions | tojson }};
        let industries = {{ industries | tojson }};
        let years = {{ years | tojson }};

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Setup event listeners
            setupEventListeners();
            
            // Load initial data
            loadDashboardStats();
            
            // Populate filter dropdowns
            populateFilters();
            
            // Load policies
            loadPolicies();
        });

        function setupEventListeners() {
            // Filter events
            document.getElementById('regionFilter').addEventListener('change', handleFilterChange);
            document.getElementById('industryFilter').addEventListener('change', handleFilterChange);
            document.getElementById('yearFilter').addEventListener('change', handleFilterChange);
            document.getElementById('typeFilter').addEventListener('change', handleFilterChange);
            
            // Search event
            document.getElementById('globalSearch').addEventListener('input', handleSearch);
            
            // Refresh button
            document.getElementById('refreshBtn')?.addEventListener('click', loadPolicies);
            
            // Check email button
            document.getElementById('checkEmailBtn').addEventListener('click', checkNewEmails);
            
            // Add policy button
            document.getElementById('addPolicySubmitBtn').addEventListener('click', addPolicyFromUrl);
        }

        function populateFilters() {
            const regionSelect = document.getElementById('regionFilter');
            const industrySelect = document.getElementById('industryFilter');
            const yearSelect = document.getElementById('yearFilter');
            
            // Add regions
            regions.forEach(region => {
                const option = document.createElement('option');
                option.value = region;
                option.textContent = region;
                regionSelect.appendChild(option);
            });
            
            // Add industries
            industries.forEach(industry => {
                const option = document.createElement('option');
                option.value = industry;
                option.textContent = industry;
                industrySelect.appendChild(option);
            });
            
            // Add years (sort in descending order)
            years.sort((a, b) => b - a);
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });
        }

        async function loadDashboardStats() {
            try {
                const response = await fetch('/api/policy-stats');
                const stats = await response.json();
                
                document.getElementById('totalPolicies').textContent = stats.total || 0;
                document.getElementById('newThisWeek').textContent = stats.newThisWeek || 0;
                document.getElementById('regionsCount').textContent = stats.regionsCount || 0;
                document.getElementById('industriesCount').textContent = stats.industriesCount || 0;
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }

        async function loadPolicies(page = 1) {
            try {
                currentPage = page;
                
                const region = document.getElementById('regionFilter').value;
                const industry = document.getElementById('industryFilter').value;
                const year = document.getElementById('yearFilter').value;
                const type = document.getElementById('typeFilter').value;
                const search = document.getElementById('globalSearch').value;
                
                const params = new URLSearchParams({
                    page: page,
                    limit: itemsPerPage,
                    region,
                    industry,
                    year,
                    type,
                    search
                });
                
                const response = await fetch(`/api/policies?${params}`);
                const data = await response.json();
                
                allPolicies = data.policies;
                renderPolicies(data.policies);
                renderPagination(data.total, page, data.limit);
                
                // Update policy count
                document.getElementById('policyCount').textContent = data.total;
            } catch (error) {
                console.error('Error loading policies:', error);
                showNotification('加载政策列表失败', 'error');
            }
        }

        // Batch operations functionality
        let selectedPolicies = new Set();

        function setupBatchOperations() {
            // Add Ctrl-click functionality to policy items for selection
            document.addEventListener('click', function(e) {
                const policyItem = e.target.closest('.policy-item');
                if (policyItem && e.ctrlKey) {
                    const policyId = policyItem.dataset.policyId;

                    if (policyItem.classList.contains('selected')) {
                        policyItem.classList.remove('selected');
                        policyItem.style.backgroundColor = '';
                        selectedPolicies.delete(parseInt(policyId));
                    } else {
                        policyItem.classList.add('selected');
                        policyItem.style.backgroundColor = '#e3f2fd';
                        selectedPolicies.add(parseInt(policyId));
                    }

                    updateSelectedCount();
                }
            });

            // Execute batch action
            document.getElementById('executeBatchActionBtn')?.addEventListener('click', executeBatchAction);

            // Set up Qwen CLI analysis button
            document.getElementById('qwenCliAnalysisBtn')?.addEventListener('click', qwenCliAnalysisHandler);
        }

        function updateSelectedCount() {
            const count = selectedPolicies.size;
            document.getElementById('selectedCount').textContent = `已选择 ${count} 条政策`;
        }

        async function executeBatchAction() {
            const actionType = document.getElementById('batchActionType').value;

            if (selectedPolicies.size === 0) {
                showNotification('请先选择要操作的政策', 'warning');
                return;
            }

            const policyIds = Array.from(selectedPolicies);

            try {
                let success = true;
                let message = '';

                switch(actionType) {
                    case 'delete':
                        // Confirm deletion
                        if (!confirm(`确定要删除选中的 ${policyIds.length} 条政策吗？此操作不可撤销。`)) {
                            return;
                        }

                        // Delete selected policies
                        for (const policyId of policyIds) {
                            const response = await fetch(`/api/policy/${policyId}`, {
                                method: 'DELETE',
                                headers: {
                                    'Content-Type': 'application/json',
                                }
                            });

                            if (!response.ok) {
                                success = false;
                                break;
                            }
                        }

                        message = `已删除 ${policyIds.length} 条政策`;
                        break;

                    case 'reanalyze':
                        // Reanalyze selected policies
                        for (const policyId of policyIds) {
                            const policy = await fetch(`/api/policy/${policyId}`).then(r => r.json());

                            if (policy.original_url) {
                                // Send to reanalysis (using the same URL to re-analyze)
                                const response = await fetch('/api/qwen-process', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        text: policy.original_url,
                                        processing_type: 'policy',
                                        custom_instruction: '请重新分析这个政策URL的内容'
                                    })
                                });

                                if (!response.ok) {
                                    success = false;
                                    break;
                                }
                            }
                        }

                        message = `已重新分析 ${policyIds.length} 条政策`;
                        break;

                    case 'export':
                        // Export selected policies
                        try {
                            const response = await fetch('/api/export-policies', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ policy_ids: policyIds })
                            });

                            if (response.ok) {
                                // Create download link for the exported file
                                const blob = await response.blob();
                                const url = window.URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = `policies_export_${new Date().toISOString().slice(0,10)}.json`;
                                document.body.appendChild(a);
                                a.click();
                                window.URL.revokeObjectURL(url);
                                document.body.removeChild(a);

                                message = `已导出 ${policyIds.length} 条政策`;
                            } else {
                                success = false;
                                message = '导出失败';
                            }
                        } catch (error) {
                            console.error('Export error:', error);
                            success = false;
                            message = '导出失败';
                        }
                        break;

                    case 'classify':
                        // Re-classify selected policies
                        for (const policyId of policyIds) {
                            const response = await fetch(`/api/policy/${policyId}/reclassify`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' }
                            });

                            if (!response.ok) {
                                success = false;
                                break;
                            }
                        }

                        message = `已重新分类 ${policyIds.length} 条政策`;
                        break;
                }

                if (success) {
                    showNotification(message, 'success');

                    // Clear selections and reload
                    selectedPolicies.clear();
                    updateSelectedCount();

                    // Reload policies
                    loadPolicies();

                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('batchActionsModal'));
                    if (modal) modal.hide();
                } else {
                    showNotification('批量操作失败', 'error');
                }
            } catch (error) {
                console.error('Error executing batch action:', error);
                showNotification('批量操作失败', 'error');
            }
        }

        async function qwenCliAnalysisHandler() {
            const url = prompt('请输入政策URL进行Qwen CLI分析:');
            if (!url) return;

            try {
                showNotification('正在提交URL到Qwen CLI分析...', 'info');

                // Submit URL for analysis
                const response = await fetch('/api/add-policy-url', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        url: url
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('URL已提交给Qwen CLI分析', 'success');
                    // Refresh the policy list to show the newly added item
                    loadPolicies();
                } else {
                    showNotification(`分析失败: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Error with Qwen CLI analysis:', error);
                showNotification('Qwen CLI分析请求失败', 'error');
            }
        }

        // Initialize batch operations when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setupBatchOperations();
        });

        function renderPolicies(policies) {
            const container = document.getElementById('policyList');
            
            if (policies.length === 0) {
                container.innerHTML = `
                    <div class="d-flex justify-content-center align-items-center p-5 text-muted">
                        <div class="text-center">
                            <i class="fas fa-inbox fa-3x mb-3" style="color: #cbd5e1;"></i>
                            <p class="mb-0">暂无政策数据</p>
                            <small class="text-muted">请尝试调整筛选条件或添加新政策</small>
                        </div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            policies.forEach(policy => {
                // Truncate title if too long
                const title = policy.title.length > 60 ? policy.title.substring(0, 60) + '...' : policy.title;
                
                // Truncate content summary if too long
                const summary = policy.content_summary ? 
                    (policy.content_summary.length > 120 ? policy.content_summary.substring(0, 120) + '...' : policy.content_summary) : 
                    '暂无摘要';
                
                // Format date
                const dateStr = policy.analyzed_at ? new Date(policy.analyzed_at).toLocaleDateString('zh-CN') : '未知日期';
                
                html += `
                    <div class="policy-item" onclick="goToPolicyDetail(${policy.id})">
                        <div class="policy-item-header">
                            <div class="policy-title">${title}</div>
                            <div class="policy-time">${dateStr}</div>
                        </div>
                        <div class="policy-summary">${summary}</div>
                        <div class="policy-tags">
                            ${policy.classification.region ? `<span class="policy-tag region-tag">${policy.classification.region}</span>` : ''}
                            ${policy.classification.industry ? `<span class="policy-tag industry-tag">${policy.classification.industry}</span>` : ''}
                            ${policy.classification.year ? `<span class="policy-tag year-tag">${policy.classification.year}年</span>` : ''}
                            ${policy.classification.policy_type ? `<span class="policy-tag type-tag">${policy.classification.policy_type}</span>` : ''}
                            ${policy.status === 'processing' ? `<span class="policy-tag processing-tag">处理中</span>` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function renderPagination(total, page, limit) {
            const totalPages = Math.ceil(total / limit);
            const container = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let html = '<nav><ul class="pagination justify-content-center">';
            
            // Previous page
            html += `<li class="page-item ${page === 1 ? 'disabled' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${Math.max(1, page - 1)})">上一页</a>
                     </li>`;
            
            // Page numbers (show up to 7 pages centered on current)
            const startPage = Math.max(1, Math.min(page - 3, totalPages - 6));
            const endPage = Math.min(totalPages, startPage + 6);
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<li class="page-item ${i === page ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                         </li>`;
            }
            
            // Next page
            html += `<li class="page-item ${page === totalPages ? 'disabled' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${Math.min(totalPages, page + 1)})">下一页</a>
                     </li>`;
            
            html += '</ul></nav>';
            container.innerHTML = html;
        }

        function changePage(page) {
            loadPolicies(page);
            // Scroll to top of policy list
            document.querySelector('.policy-list').scrollTo({ top: 0, behavior: 'smooth' });
        }

        function handleFilterChange() {
            // Reset to first page when filters change
            loadPolicies(1);
        }

        function handleSearch() {
            // Debounce search to avoid too many API calls
            clearTimeout(window.searchTimeout);
            window.searchTimeout = setTimeout(() => {
                loadPolicies(1); // Reset to first page on search
            }, 500);
        }

        async function goToPolicyDetail(policyId) {
            // Navigate to the enhanced WeChat-style analysis page
            window.location.href = `/policy-analysis/detail/${policyId}/wechat`;
        }

        async function checkNewEmails() {
            try {
                const response = await fetch('/api/check-email-policies', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`发现 ${result.new_policies} 条新政策`, 'success');
                    loadPolicies(); // Reload policies
                } else {
                    showNotification('检查邮件失败: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error checking emails:', error);
                showNotification('检查邮件失败', 'error');
            }
        }

        async function addPolicyFromUrl() {
            const urlInput = document.getElementById('policyUrl');
            const url = urlInput.value.trim();
            const submitBtn = document.getElementById('addPolicySubmitBtn');
            
            if (!url) {
                showNotification('请输入政策URL', 'error');
                return;
            }
            
            // Validate URL format
            try {
                new URL(url);
            } catch (e) {
                showNotification('请输入有效的URL', 'error');
                return;
            }
            
            // Disable submit button and show status
            submitBtn.disabled = true;
            submitBtn.textContent = '处理中...';
            document.getElementById('analysisStatus').style.display = 'block';
            document.getElementById('statusText').textContent = '正在提交分析请求...';
            document.getElementById('progressBar').style.width = '0%';
            
            try {
                // Submit the URL for analysis
                const response = await fetch('/api/add-policy-url', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: url })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('政策提交成功，正在后台分析', 'success');
                    
                    // Update status to processing
                    document.getElementById('statusText').textContent = '政策已提交，正在后台分析...';
                    document.getElementById('progressBar').style.width = '100%';
                    
                    // Optionally close modal after a delay
                    setTimeout(() => {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('addPolicyModal'));
                        if (modal) modal.hide();
                        
                        // Reset form
                        urlInput.value = '';
                        submitBtn.disabled = false;
                        submitBtn.textContent = '添加并分析';
                        document.getElementById('analysisStatus').style.display = 'none';
                        
                        // Reload policies after a short delay to show the new entry
                        setTimeout(() => {
                            loadPolicies();
                        }, 2000);
                    }, 1500);
                } else {
                    throw new Error(result.error || '添加政策失败');
                }
            } catch (error) {
                console.error('Error adding policy:', error);
                showNotification(`添加失败: ${error.message}`, 'error');
                
                // Re-enable button after error
                submitBtn.disabled = false;
                submitBtn.textContent = '添加并分析';
            }
        }

        function showNotification(message, type = 'info') {
            const toastEl = document.getElementById('liveToast');
            const toastTitle = document.getElementById('toastTitle');
            const toastBody = document.getElementById('toastBody');
            
            // Set toast content
            toastBody.textContent = message;
            toastTitle.textContent = type === 'error' ? '错误' : type === 'success' ? '成功' : '通知';
            
            // Change header color based on type
            const header = toastEl.querySelector('.toast-header');
            header.className = 'toast-header';
            if (type === 'error') {
                header.classList.add('bg-danger', 'text-white');
            } else if (type === 'success') {
                header.classList.add('bg-success', 'text-white');
            } else {
                header.classList.add('bg-primary', 'text-white');
            }
            
            // Create and show toast
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }

        // Expose functions to global scope for inline event handlers
        window.changePage = changePage;
        window.goToPolicyDetail = goToPolicyDetail;
        window.loadPolicies = loadPolicies;
        window.handleFilterChange = handleFilterChange;
    </script>

    <!-- Batch Actions Modal -->
    <div class="modal fade" id="batchActionsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">批量操作</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">选择操作类型</label>
                        <select class="form-select" id="batchActionType">
                            <option value="delete">删除选中政策</option>
                            <option value="reanalyze">重新分析选中政策</option>
                            <option value="export">导出选中政策</option>
                            <option value="classify">重新分类选中政策</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="selectAllCheckbox">
                            <label class="form-check-label" for="selectAllCheckbox">
                                全选当前页面政策
                            </label>
                        </div>
                    </div>
                    <div id="selectedCount" class="text-muted">
                        已选择 0 条政策
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            提示：按住Ctrl键可多选政策
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="executeBatchActionBtn">执行操作</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>